<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="R2D2 Production Control Dashboard - Phase 2 with Threshold-Based Alert System">
    <title>R2D2 Production Dashboard - Phase 2 Alerts</title>

    <!-- External Dependencies -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* ================================================================ */
        /* CSS VARIABLES - DARK THEME COLOR PALETTE */
        /* ================================================================ */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-primary: #3b82f6;
            --accent-secondary: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-disabled: #64748b;
            --status-success: #10b981;
            --status-warning: #f59e0b;
            --status-error: #ef4444;
            --status-info: #3b82f6;
            --status-connected: #22c55e;
            --status-disconnected: #dc2626;
            --detection-box: #22c55e;
            --detection-label-bg: rgba(0, 0, 0, 0.7);

            /* Graph threshold colors */
            --color-safe: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }

        /* ================================================================ */
        /* GLOBAL RESET AND BASE STYLES */
        /* ================================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ================================================================ */
        /* HEADER SECTION */
        /* ================================================================ */
        .header {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-bottom: 2px solid var(--accent-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* Connection Status (Fixed Top-Right) */
        .connection-status {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: linear-gradient(135deg, var(--status-connected), #059669);
            color: white;
        }

        .connection-status.disconnected {
            background: linear-gradient(135deg, var(--status-disconnected), #991b1b);
            color: white;
        }

        .connection-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* ================================================================ */
        /* MAIN GRID LAYOUT */
        /* ================================================================ */
        .main-container {
            display: grid;
            grid-template-columns: 2fr 1.75fr 1.25fr;
            gap: 20px;
            padding: 20px;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* ================================================================ */
        /* PANEL BASE STYLES */
        /* ================================================================ */
        .panel {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: border-color 0.3s ease;
        }

        .panel:hover {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .panel.alert-active {
            border-color: var(--accent-warning);
            animation: borderPulse 1.5s infinite;
        }

        .panel.alert-danger {
            border-color: var(--accent-danger);
            animation: borderPulseDanger 1.5s infinite;
        }

        @keyframes borderPulse {
            0%, 100% { border-color: var(--accent-warning); opacity: 1; }
            50% { border-color: rgba(245, 158, 11, 0.5); opacity: 0.8; }
        }

        @keyframes borderPulseDanger {
            0%, 100% { border-color: var(--accent-danger); opacity: 1; }
            50% { border-color: rgba(239, 68, 68, 0.5); opacity: 0.8; }
        }

        .panel-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ================================================================ */
        /* VIDEO FEED PANEL */
        /* ================================================================ */
        .video-panel {
            grid-column: 1;
            grid-row: 1;
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .video-fps, .video-latency {
            background: rgba(0, 0, 0, 0.7);
            color: var(--status-connected);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .video-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .video-info-item {
            background: rgba(51, 65, 85, 0.6);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .video-info-label {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .video-info-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* Detection List */
        .detection-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .detection-item {
            background: rgba(51, 65, 85, 0.6);
            border-left: 3px solid var(--detection-box);
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detection-class {
            font-weight: 600;
            color: var(--text-primary);
        }

        .detection-confidence {
            background: var(--accent-primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ================================================================ */
        /* MOOD/ANIMATION CONTROL PANEL */
        /* ================================================================ */
        .control-panel {
            grid-column: 2;
            grid-row: 1;
            overflow-y: auto;
            max-height: 85vh;
        }

        .mood-grid, .animation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .mood-btn, .animation-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mood-btn:hover, .animation-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }

        .mood-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulseActive 1.5s infinite;
        }

        @keyframes pulseActive {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animation-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        /* Mood Status Display */
        .mood-status {
            background: rgba(51, 65, 85, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .mood-status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .mood-progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(51, 65, 85, 0.6);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .mood-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
            width: 0%;
        }

        /* ================================================================ */
        /* METRICS PANEL */
        /* ================================================================ */
        .metrics-panel {
            grid-column: 3;
            grid-row: 1;
        }

        .metric-card {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: rgba(59, 130, 246, 0.6);
            transform: translateY(-2px);
        }

        .metric-card.alert-warning {
            border-color: var(--accent-warning);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        }

        .metric-card.alert-danger {
            border-color: var(--accent-danger);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            animation: metricPulse 1.5s infinite;
        }

        @keyframes metricPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--status-success);
            margin: 10px 0;
        }

        .metric-value.warning {
            color: var(--status-warning);
        }

        .metric-value.danger {
            color: var(--status-error);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Alert Panel */
        .alert-panel {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 0.85rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .alert:hover {
            opacity: 0.8;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.15);
            border-left: 4px solid var(--status-success);
            color: var(--status-success);
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.15);
            border-left: 4px solid var(--status-warning);
            color: var(--status-warning);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.15);
            border-left: 4px solid var(--status-error);
            color: var(--status-error);
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.15);
            border-left: 4px solid var(--status-info);
            color: var(--status-info);
        }

        .alert-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .alert-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .alert-message {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .alert-timestamp {
            font-size: 0.7rem;
            opacity: 0.7;
            font-family: 'Courier New', monospace;
        }

        .clear-alerts-btn {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clear-alerts-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        /* ================================================================ */
        /* PHASE 2: PERFORMANCE GRAPHS PANEL */
        /* ================================================================ */
        .graphs-panel {
            grid-column: 1 / -1;
            grid-row: 2;
            margin-top: 0;
        }

        .graphs-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .graph-card {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            min-height: 350px;
            transition: all 0.3s ease;
        }

        .graph-card:hover {
            border-color: rgba(59, 130, 246, 0.6);
            transform: translateY(-2px);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .graph-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .graph-current-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .graph-current-value.safe { color: var(--color-safe); }
        .graph-current-value.warning { color: var(--color-warning); }
        .graph-current-value.danger { color: var(--color-danger); }

        .graph-canvas-container {
            position: relative;
            height: 200px;
            margin-bottom: 15px;
        }

        .graph-canvas {
            width: 100%;
            height: 100%;
        }

        .graph-legend {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .graph-legend-item {
            text-align: center;
            padding: 8px;
            background: rgba(51, 65, 85, 0.4);
            border-radius: 6px;
        }

        .graph-legend-label {
            display: block;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .graph-legend-value {
            display: block;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
        }

        /* ================================================================ */
        /* EMERGENCY STOP BUTTON */
        /* ================================================================ */
        .emergency-stop {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .emergency-stop button {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
            transition: all 0.3s ease;
            animation: emergencyPulse 2s ease-in-out infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 8px 35px rgba(220, 38, 38, 0.7); }
        }

        .emergency-stop button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(220, 38, 38, 0.6);
        }

        /* ================================================================ */
        /* RESPONSIVE DESIGN */
        /* ================================================================ */
        @media (max-width: 1439px) {
            .main-container {
                grid-template-columns: 1.8fr 1fr;
            }

            .control-panel {
                grid-column: 2;
                grid-row: 1;
            }

            .metrics-panel {
                grid-column: 1 / -1;
                grid-row: 2;
            }

            .graphs-panel {
                grid-column: 1 / -1;
                grid-row: 3;
            }

            .graphs-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1023px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .video-panel,
            .control-panel,
            .metrics-panel,
            .graphs-panel {
                grid-column: 1;
            }

            .graphs-container {
                grid-template-columns: repeat(1, 1fr);
            }

            .mood-grid,
            .animation-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ================================================================ */
        /* LOADING STATE */
        /* ================================================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(59, 130, 246, 0.3);
            border-top: 5px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        /* ================================================================ */
        /* SCROLLBAR STYLING */
        /* ================================================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing R2D2 Dashboard Phase 2 with Alert System...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>R2D2 Production Control Dashboard - Phase 2</h1>
        <div class="header-subtitle">Real-time YOLO Vision & WCB with Intelligent Threshold-Based Alert System</div>
    </div>

    <!-- Connection Status (Fixed) -->
    <div class="connection-status disconnected" id="connectionStatus">
        <div class="connection-status-dot"></div>
        <span>Connecting...</span>
    </div>

    <!-- Main Grid Container -->
    <div class="main-container">
        <!-- Left Column: Video Feed -->
        <div class="panel video-panel">
            <div class="panel-header">Live Vision Feed</div>
            <div class="video-container">
                <img id="videoFeed" alt="Video feed from camera">
                <canvas id="detectionCanvas" width="640" height="480"></canvas>
                <div class="video-overlay">
                    <div class="video-fps" id="videoFps">FPS: --</div>
                    <div class="video-latency" id="videoLatency">Latency: --</div>
                </div>
            </div>

            <div class="video-info">
                <div class="video-info-item">
                    <div class="video-info-label">Resolution</div>
                    <div class="video-info-value" id="videoResolution">640x480</div>
                </div>
                <div class="video-info-item">
                    <div class="video-info-label">Detections</div>
                    <div class="video-info-value" id="detectionCount">0</div>
                </div>
            </div>

            <div class="panel-header" style="margin-top: 20px;">Current Detections</div>
            <div class="detection-list" id="detectionList">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                    No detections yet...
                </div>
            </div>
        </div>

        <!-- Center Column: Mood/Animation Control -->
        <div class="panel control-panel">
            <div class="panel-header">WCB Mood Control</div>
            <div class="mood-grid" id="moodGrid">
                <!-- Mood buttons will be dynamically generated -->
            </div>

            <div class="panel-header" style="margin-top: 25px;">Animation Control</div>
            <div class="animation-grid" id="animationGrid">
                <!-- Animation buttons will be dynamically generated -->
            </div>

            <div class="panel-header" style="margin-top: 25px;">Mood Status</div>
            <div class="mood-status">
                <div class="mood-status-item">
                    <span>Current Mood:</span>
                    <strong id="currentMood">Idle</strong>
                </div>
                <div class="mood-status-item">
                    <span>Progress:</span>
                    <strong id="moodProgress">0%</strong>
                </div>
                <div class="mood-progress-bar">
                    <div class="mood-progress-fill" id="moodProgressFill"></div>
                </div>
            </div>
        </div>

        <!-- Right Column: Performance Metrics -->
        <div class="panel metrics-panel">
            <div class="panel-header">Performance Metrics</div>

            <div class="metric-card" id="metricCardFPS">
                <div class="metric-label">FPS</div>
                <div class="metric-value" id="metricFPS">--</div>
            </div>

            <div class="metric-card" id="metricCardGPU">
                <div class="metric-label">GPU Utilization</div>
                <div class="metric-value" id="metricGPU">--</div>
            </div>

            <div class="metric-card" id="metricCardMemory">
                <div class="metric-label">Memory Usage</div>
                <div class="metric-value" id="metricMemory">--</div>
            </div>

            <div class="metric-card" id="metricCardTemp">
                <div class="metric-label">Temperature</div>
                <div class="metric-value" id="metricTemp">--</div>
            </div>

            <div class="metric-card" id="metricCardCPU">
                <div class="metric-label">CPU Utilization</div>
                <div class="metric-value" id="metricCPU">--</div>
            </div>

            <div class="panel-header" style="margin-top: 20px;">System Alerts</div>
            <div class="alert-panel" id="alertPanel">
                <!-- Alerts will be dynamically added -->
            </div>
            <button class="clear-alerts-btn" onclick="clearAlertHistory()">Clear Alert History</button>
        </div>

        <!-- Bottom: PHASE 2 - Historical Performance Graphs -->
        <div class="panel graphs-panel">
            <div class="panel-header">System Performance Graphs (60s History)</div>
            <div class="graphs-container">
                <!-- GPU Utilization Graph -->
                <div class="graph-card">
                    <div class="graph-header">
                        <span class="graph-title">GPU Utilization</span>
                        <span class="graph-current-value safe" id="gpuCurrentValue">--</span>
                    </div>
                    <div class="graph-canvas-container">
                        <canvas class="graph-canvas" id="gpuChart"></canvas>
                    </div>
                    <div class="graph-legend">
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Min</span>
                            <span class="graph-legend-value" id="gpuMin">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Avg</span>
                            <span class="graph-legend-value" id="gpuAvg">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Max</span>
                            <span class="graph-legend-value" id="gpuMax">--</span>
                        </div>
                    </div>
                </div>

                <!-- Memory Usage Graph -->
                <div class="graph-card">
                    <div class="graph-header">
                        <span class="graph-title">System Memory</span>
                        <span class="graph-current-value safe" id="memoryCurrentValue">--</span>
                    </div>
                    <div class="graph-canvas-container">
                        <canvas class="graph-canvas" id="memoryChart"></canvas>
                    </div>
                    <div class="graph-legend">
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Min</span>
                            <span class="graph-legend-value" id="memoryMin">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Avg</span>
                            <span class="graph-legend-value" id="memoryAvg">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Max</span>
                            <span class="graph-legend-value" id="memoryMax">--</span>
                        </div>
                    </div>
                </div>

                <!-- Temperature Graph -->
                <div class="graph-card">
                    <div class="graph-header">
                        <span class="graph-title">Temperature</span>
                        <span class="graph-current-value safe" id="tempCurrentValue">--</span>
                    </div>
                    <div class="graph-canvas-container">
                        <canvas class="graph-canvas" id="tempChart"></canvas>
                    </div>
                    <div class="graph-legend">
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Min</span>
                            <span class="graph-legend-value" id="tempMin">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Avg</span>
                            <span class="graph-legend-value" id="tempAvg">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Max</span>
                            <span class="graph-legend-value" id="tempMax">--</span>
                        </div>
                    </div>
                </div>

                <!-- CPU Utilization Graph -->
                <div class="graph-card">
                    <div class="graph-header">
                        <span class="graph-title">CPU Utilization</span>
                        <span class="graph-current-value safe" id="cpuCurrentValue">--</span>
                    </div>
                    <div class="graph-canvas-container">
                        <canvas class="graph-canvas" id="cpuChart"></canvas>
                    </div>
                    <div class="graph-legend">
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Min</span>
                            <span class="graph-legend-value" id="cpuMin">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Avg</span>
                            <span class="graph-legend-value" id="cpuAvg">--</span>
                        </div>
                        <div class="graph-legend-item">
                            <span class="graph-legend-label">Max</span>
                            <span class="graph-legend-value" id="cpuMax">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Stop Button (Fixed) -->
    <div class="emergency-stop">
        <button onclick="executeEmergencyStop()">EMERGENCY STOP</button>
    </div>

    <!-- Security Utilities Script -->
    <script src="dashboard-security-utils.js"></script>

    <!-- Main Dashboard Script -->
    <script>
        // ================================================================
        // CONFIGURATION
        // ================================================================
        const VISION_WS_URL = 'ws://localhost:8767';
        const WCB_API_URL = 'http://localhost:8770';
        const AUTH_TOKEN = localStorage.getItem('r2d2_auth_token') || 'fd81ba71-43f6-4bb3-afb5-e8dc3f9eb12e';

        // Initialize authentication
        initializeAuth(AUTH_TOKEN);

        // ================================================================
        // PHASE 2: PERFORMANCE THRESHOLDS (from requirements)
        // ================================================================
        const THRESHOLDS = {
            gpu_utilization: { warning: 85, danger: 95 },
            temperature_c: { warning: 60, danger: 70 },
            system_memory_mb: { warning: 7000, danger: 7500 },  // MB
            cpu_utilization: { warning: 80, danger: 95 }
        };

        // ================================================================
        // PHASE 2: THRESHOLD-BASED ALERT SYSTEM
        // ================================================================
        const alertSystem = {
            // Current active alerts (metric -> alert object)
            activeAlerts: new Map(),

            // Alert history (last 20 alerts)
            history: [],

            // Throttling (metric -> timestamp) - prevent spam
            lastAlertTime: new Map(),

            // Throttle interval (10 seconds)
            throttleInterval: 10000,

            // Max alerts to keep in history
            maxHistory: 20
        };

        /**
         * Check thresholds for all metrics and trigger alerts if needed
         * @param {Object} metrics - Current metrics from WebSocket
         */
        function checkThresholds(metrics) {
            const now = Date.now();

            // Check each metric that has threshold configuration
            Object.keys(THRESHOLDS).forEach(metricName => {
                const value = metrics[metricName];

                // Skip if metric is not provided or invalid
                if (value === undefined || value === null || isNaN(value)) {
                    return;
                }

                const threshold = THRESHOLDS[metricName];

                // Check if we're throttling this metric
                const lastAlert = alertSystem.lastAlertTime.get(metricName) || 0;
                const timeSinceLastAlert = now - lastAlert;

                // Determine severity
                let severity = null;
                if (value >= threshold.danger) {
                    severity = 'DANGER';
                } else if (value >= threshold.warning) {
                    severity = 'WARNING';
                }

                if (severity) {
                    // Trigger alert only if not throttled
                    if (timeSinceLastAlert >= alertSystem.throttleInterval) {
                        triggerAlert(metricName, severity, value, threshold[severity.toLowerCase()]);
                        alertSystem.lastAlertTime.set(metricName, now);
                    }
                } else {
                    // Clear alert if condition resolved
                    clearAlert(metricName);
                }
            });
        }

        /**
         * Trigger a threshold alert
         * @param {string} metric - Metric name
         * @param {string} severity - 'WARNING' or 'DANGER'
         * @param {number} value - Current value
         * @param {number} threshold - Threshold value exceeded
         */
        function triggerAlert(metric, severity, value, threshold) {
            const now = Date.now();

            // Create alert object
            const alert = {
                metric,
                severity,
                value,
                threshold,
                timestamp: now,
                active: true
            };

            // Add to active alerts
            alertSystem.activeAlerts.set(metric, alert);

            // Add to history
            alertSystem.history.push({
                ...alert,
                id: `alert_${now}_${metric}`
            });

            // Maintain history limit (keep last 20)
            if (alertSystem.history.length > alertSystem.maxHistory) {
                alertSystem.history.shift();
            }

            // Display alert notification
            const message = formatAlertMessage(metric, value, threshold);
            const type = severity === 'DANGER' ? 'error' : 'warning';
            showAlert(message, type, metric, value, threshold);

            // Visual highlighting
            highlightMetricUI(metric, severity);

            // Log to console
            console.warn(`[${severity}] ${message}`);
        }

        /**
         * Clear alert when condition is resolved
         * @param {string} metric - Metric name
         */
        function clearAlert(metric) {
            if (alertSystem.activeAlerts.has(metric)) {
                alertSystem.activeAlerts.delete(metric);
                removeMetricHighlight(metric);
            }
        }

        /**
         * Format alert message for display
         * @param {string} metric - Metric name
         * @param {number} value - Current value
         * @param {number} threshold - Threshold exceeded
         * @returns {string} Formatted message
         */
        function formatAlertMessage(metric, value, threshold) {
            const metricNames = {
                'gpu_utilization': 'GPU Utilization',
                'temperature_c': 'Temperature',
                'system_memory_mb': 'System Memory',
                'cpu_utilization': 'CPU Utilization'
            };

            const metricUnits = {
                'gpu_utilization': '%',
                'temperature_c': 'Â°C',
                'system_memory_mb': ' MB',
                'cpu_utilization': '%'
            };

            const name = metricNames[metric] || metric;
            const unit = metricUnits[metric] || '';

            return `${name}: ${value}${unit} (threshold: ${threshold}${unit})`;
        }

        /**
         * Highlight metric UI to show alert state
         * @param {string} metric - Metric name
         * @param {string} severity - 'WARNING' or 'DANGER'
         */
        function highlightMetricUI(metric, severity) {
            const metricCardMap = {
                'gpu_utilization': 'metricCardGPU',
                'temperature_c': 'metricCardTemp',
                'system_memory_mb': 'metricCardMemory',
                'cpu_utilization': 'metricCardCPU'
            };

            const cardId = metricCardMap[metric];
            if (!cardId) return;

            const card = document.getElementById(cardId);
            if (!card) return;

            // Remove existing alert classes
            card.classList.remove('alert-warning', 'alert-danger');

            // Add new alert class
            if (severity === 'DANGER') {
                card.classList.add('alert-danger');
            } else if (severity === 'WARNING') {
                card.classList.add('alert-warning');
            }
        }

        /**
         * Remove metric UI highlighting
         * @param {string} metric - Metric name
         */
        function removeMetricHighlight(metric) {
            const metricCardMap = {
                'gpu_utilization': 'metricCardGPU',
                'temperature_c': 'metricCardTemp',
                'system_memory_mb': 'metricCardMemory',
                'cpu_utilization': 'metricCardCPU'
            };

            const cardId = metricCardMap[metric];
            if (!cardId) return;

            const card = document.getElementById(cardId);
            if (!card) return;

            // Remove alert classes
            card.classList.remove('alert-warning', 'alert-danger');
        }

        /**
         * Clear all alerts from history
         */
        function clearAlertHistory() {
            alertSystem.history = [];
            const alertPanel = document.getElementById('alertPanel');
            alertPanel.innerHTML = '';
            console.log('Alert history cleared');
        }

        // ================================================================
        // MOOD AND ANIMATION DEFINITIONS
        // ================================================================
        const MOODS = [
            { id: 1, name: 'Greeting Friendly', emoji: 'ðŸ‘‹' },
            { id: 2, name: 'Happy Excited', emoji: 'ðŸŽ‰' },
            { id: 3, name: 'Sad Worried', emoji: 'ðŸ˜¢' },
            { id: 4, name: 'Angry Upset', emoji: 'ðŸ˜ ' },
            { id: 5, name: 'Excited Happy', emoji: 'ðŸ˜„' },
            { id: 6, name: 'Scared Afraid', emoji: 'ðŸ˜¨' },
            { id: 7, name: 'Curious Interested', emoji: 'ðŸ¤”' },
            { id: 8, name: 'Playful Fun', emoji: 'ðŸ˜œ' },
            { id: 9, name: 'Proud Accomplished', emoji: 'ðŸ˜Ž' },
            { id: 10, name: 'Sleepy Tired', emoji: 'ðŸ˜´' }
        ];

        const ANIMATIONS = [
            { id: 1, name: 'Wave', emoji: 'ðŸ‘‹' },
            { id: 2, name: 'Nod', emoji: 'ðŸ‘' },
            { id: 3, name: 'Shake Head', emoji: 'ðŸ‘Ž' },
            { id: 4, name: 'Spin', emoji: 'ðŸ”„' },
            { id: 5, name: 'Happy Dance', emoji: 'ðŸ’ƒ' },
            { id: 6, name: 'Scared', emoji: 'ðŸ˜±' },
            { id: 7, name: 'Scan', emoji: 'ðŸ”' },
            { id: 8, name: 'Sleep Mode', emoji: 'ðŸ˜´' }
        ];

        // ================================================================
        // GLOBAL STATE
        // ================================================================
        let visionWs = null;
        let visionConnected = false;
        let wcbConnected = false;

        // PHASE 2: Chart instances
        let gpuChart, memoryChart, tempChart, cpuChart;

        // PHASE 2: Circular buffer for historical metrics (60 seconds at 500ms = 120 data points)
        const MAX_DATA_POINTS = 120;
        const metricsHistory = {
            timestamps: [],
            gpu: [],
            memory: [],
            temperature: [],
            cpu: []
        };

        // ================================================================
        // INITIALIZATION
        // ================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ R2D2 Production Dashboard Phase 2 with Alert System initializing...');

            // Generate mood and animation buttons
            generateMoodButtons();
            generateAnimationButtons();

            // PHASE 2: Initialize performance charts
            initializePerformanceCharts();

            // Connect to vision system
            connectVisionFeed();

            // Start WCB health check
            checkWCBHealth();
            setInterval(checkWCBHealth, 10000);

            // Start mood status polling
            setInterval(pollMoodStatus, 500);

            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 1000);

            console.log('âœ… Dashboard Phase 2 with Alert System initialized successfully');
        });

        // ================================================================
        // UI GENERATION
        // ================================================================
        function generateMoodButtons() {
            const grid = document.getElementById('moodGrid');
            MOODS.forEach(mood => {
                const button = createSafeElement('button', {
                    className: 'mood-btn',
                    'data-mood': mood.id
                });
                button.textContent = `${mood.emoji} ${mood.name}`;
                button.onclick = () => executeMood(mood.id);
                grid.appendChild(button);
            });
        }

        function generateAnimationButtons() {
            const grid = document.getElementById('animationGrid');
            ANIMATIONS.forEach(anim => {
                const button = createSafeElement('button', {
                    className: 'animation-btn',
                    'data-animation': anim.id
                });
                button.textContent = `${anim.emoji} ${anim.name}`;
                button.onclick = () => executeAnimation(anim.id);
                grid.appendChild(button);
            });
        }

        // ================================================================
        // PHASE 2: CHART INITIALIZATION
        // ================================================================
        function initializePerformanceCharts() {
            console.log('Initializing Phase 2 performance charts...');

            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 100  // Fast animation for smooth updates
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#cbd5e1',
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            display: false  // Hide x-axis labels for cleaner look
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };

            // GPU Utilization Chart (0-100%)
            gpuChart = new Chart(document.getElementById('gpuChart'), {
                type: 'line',
                data: {
                    labels: metricsHistory.timestamps,
                    datasets: [{
                        label: 'GPU %',
                        data: metricsHistory.gpu,
                        borderColor: '#10b981',
                        backgroundColor: createGradient('gpuChart', '#10b981'),
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            max: 100,
                            ticks: {
                                ...commonOptions.scales.y.ticks,
                                callback: (value) => value + '%'
                            }
                        }
                    }
                }
            });

            // Memory Usage Chart (0-8000 MB)
            memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'line',
                data: {
                    labels: metricsHistory.timestamps,
                    datasets: [{
                        label: 'Memory MB',
                        data: metricsHistory.memory,
                        borderColor: '#3b82f6',
                        backgroundColor: createGradient('memoryChart', '#3b82f6'),
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            max: 8000,
                            ticks: {
                                ...commonOptions.scales.y.ticks,
                                callback: (value) => value + ' MB'
                            }
                        }
                    }
                }
            });

            // Temperature Chart (30-80Â°C)
            tempChart = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: metricsHistory.timestamps,
                    datasets: [{
                        label: 'Temperature Â°C',
                        data: metricsHistory.temperature,
                        borderColor: '#f59e0b',
                        backgroundColor: createGradient('tempChart', '#f59e0b'),
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 30,
                            max: 80,
                            ticks: {
                                ...commonOptions.scales.y.ticks,
                                callback: (value) => value + 'Â°C'
                            }
                        }
                    }
                }
            });

            // CPU Utilization Chart (0-100%)
            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: {
                    labels: metricsHistory.timestamps,
                    datasets: [{
                        label: 'CPU %',
                        data: metricsHistory.cpu,
                        borderColor: '#ef4444',
                        backgroundColor: createGradient('cpuChart', '#ef4444'),
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            max: 100,
                            ticks: {
                                ...commonOptions.scales.y.ticks,
                                callback: (value) => value + '%'
                            }
                        }
                    }
                }
            });

            console.log('âœ… Phase 2 charts initialized');
        }

        // Helper function to create gradient backgrounds
        function createGradient(canvasId, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);

            // Parse color and create gradient
            const alpha = '40';  // 25% opacity
            gradient.addColorStop(0, color + alpha);
            gradient.addColorStop(1, color + '00');

            return gradient;
        }

        // ================================================================
        // PHASE 2: METRICS COLLECTION AND UPDATE
        // ================================================================
        function addMetricData(data) {
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // Add new data
            metricsHistory.timestamps.push(timestamp);
            metricsHistory.gpu.push(data.gpu_utilization || 0);
            metricsHistory.memory.push(data.system_memory_mb || 0);
            metricsHistory.temperature.push(data.temperature_c || 0);
            metricsHistory.cpu.push(data.cpu_utilization || 0);

            // Maintain circular buffer (keep only last 120 data points = 60 seconds at 500ms)
            if (metricsHistory.timestamps.length > MAX_DATA_POINTS) {
                metricsHistory.timestamps.shift();
                metricsHistory.gpu.shift();
                metricsHistory.memory.shift();
                metricsHistory.temperature.shift();
                metricsHistory.cpu.shift();
            }

            // Update charts smoothly
            updateAllCharts();
        }

        function updateAllCharts() {
            // Update GPU chart
            updateChart(gpuChart, metricsHistory.gpu, 'gpu', '%');

            // Update Memory chart
            updateChart(memoryChart, metricsHistory.memory, 'memory', ' MB');

            // Update Temperature chart
            updateChart(tempChart, metricsHistory.temperature, 'temperature', 'Â°C');

            // Update CPU chart
            updateChart(cpuChart, metricsHistory.cpu, 'cpu', '%');
        }

        function updateChart(chart, data, metricName, unit) {
            // Update chart data
            chart.update('none');  // 'none' mode = no animation for performance

            // Calculate statistics
            if (data.length === 0) return;

            const current = data[data.length - 1];
            const min = Math.min(...data);
            const max = Math.max(...data);
            const avg = data.reduce((a, b) => a + b, 0) / data.length;

            // Update current value with color coding
            const currentValueEl = document.getElementById(`${metricName}CurrentValue`);
            if (currentValueEl) {
                setTextContent(currentValueEl, current.toFixed(1) + unit);

                // Apply color based on thresholds
                const thresholdMap = {
                    'gpu': 'gpu_utilization',
                    'memory': 'system_memory_mb',
                    'temperature': 'temperature_c',
                    'cpu': 'cpu_utilization'
                };

                const thresholdKey = thresholdMap[metricName];
                const threshold = THRESHOLDS[thresholdKey];

                if (threshold) {
                    currentValueEl.className = 'graph-current-value ' +
                        getThresholdClass(current, threshold);
                }
            }

            // Update legend statistics
            setTextContent(document.getElementById(`${metricName}Min`), min.toFixed(1) + unit);
            setTextContent(document.getElementById(`${metricName}Avg`), avg.toFixed(1) + unit);
            setTextContent(document.getElementById(`${metricName}Max`), max.toFixed(1) + unit);
        }

        function getThresholdClass(value, threshold) {
            if (value >= threshold.danger) return 'danger';
            if (value >= threshold.warning) return 'warning';
            return 'safe';
        }

        // ================================================================
        // WEBSOCKET CONNECTION - VISION SYSTEM
        // ================================================================
        function connectVisionFeed() {
            const wsUrlWithAuth = `${VISION_WS_URL}?token=${AUTH_TOKEN}`;
            console.log('Connecting to vision WebSocket:', wsUrlWithAuth);

            try {
                visionWs = new WebSocket(wsUrlWithAuth);

                visionWs.onopen = () => {
                    console.log('âœ… Vision feed connected');
                    visionConnected = true;
                    updateConnectionStatus();
                    showAlert('Vision feed connected', 'success', null, null, null, 3000);
                };

                visionWs.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleVisionMessage(data);
                    } catch (error) {
                        console.error('Error parsing vision message:', error);
                    }
                };

                visionWs.onerror = (error) => {
                    console.error('Vision WebSocket error:', error);
                };

                visionWs.onclose = () => {
                    console.log('Vision feed disconnected, reconnecting...');
                    visionConnected = false;
                    updateConnectionStatus();
                    setTimeout(connectVisionFeed, 3000);
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                setTimeout(connectVisionFeed, 3000);
            }
        }

        function handleVisionMessage(data) {
            switch (data.type) {
                case 'video_frame':
                case 'vision_data':
                    renderFrame(data);
                    updateMetrics(data);
                    if (data.detections) {
                        renderDetections(data.detections);
                        updateDetectionList(data.detections);
                    }
                    break;

                case 'character_vision_data':
                    // Handle character vision data (primary message type from vision system)
                    renderFrame(data);

                    // Extract stats from nested structure
                    const stats = data.stats || {};

                    // Merge stats into top-level for updateMetrics compatibility
                    const metricsData = {
                        fps: stats.fps,
                        gpu_utilization: stats.gpu_utilization,
                        system_memory_mb: stats.system_memory_mb,
                        temperature_c: stats.temperature_c,
                        cpu_utilization: stats.cpu_utilization,
                        latency_ms: stats.capture_latency
                    };

                    updateMetrics(metricsData);

                    // Handle detections
                    if (data.detections) {
                        renderDetections(data.detections);
                        updateDetectionList(data.detections);
                    }

                    // Show character detection alert if present
                    if (data.character_detected) {
                        showAlert(`Character detected: ${data.character_name}`, 'success', null, null, null, 5000);
                    }
                    break;

                case 'metrics':
                    updateMetrics(data);
                    break;

                case 'error':
                    console.error(`Vision Error [${data.severity}]:`, data.message);
                    showAlert(data.message, 'error', null, null, null, 10000);
                    break;
            }
        }

        function renderFrame(data) {
            if (!data.frame) return;

            const img = document.getElementById('videoFeed');
            img.src = `data:image/jpeg;base64,${data.frame}`;
            img.style.display = 'block';
        }

        function renderDetections(detections) {
            const canvas = document.getElementById('detectionCanvas');
            const ctx = canvas.getContext('2d');

            // Clear previous detections
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            detections.forEach(det => {
                const [x1, y1, x2, y2] = det.bbox;
                const width = x2 - x1;
                const height = y2 - y1;

                // Draw bounding box
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, width, height);

                // Draw label background
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(x1, y1 - 25, 150, 25);

                // Draw label text
                ctx.fillStyle = '#f8fafc';
                ctx.font = '14px Inter';
                ctx.fillText(
                    `${det.class} (${(det.confidence * 100).toFixed(0)}%)`,
                    x1 + 5,
                    y1 - 8
                );
            });
        }

        function updateDetectionList(detections) {
            const list = document.getElementById('detectionList');
            setTextContent(document.getElementById('detectionCount'), detections.length);

            if (detections.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No detections yet...</div>';
                return;
            }

            list.innerHTML = '';
            detections.forEach(det => {
                const item = createSafeElement('div', { className: 'detection-item' });
                const classEl = createSafeElement('span', { className: 'detection-class' });
                setTextContent(classEl, det.class);
                const confEl = createSafeElement('span', { className: 'detection-confidence' });
                setTextContent(confEl, `${(det.confidence * 100).toFixed(0)}%`);
                item.appendChild(classEl);
                item.appendChild(confEl);
                list.appendChild(item);
            });
        }

        function updateMetrics(data) {
            // Update FPS
            if (data.fps !== undefined) {
                setTextContent(document.getElementById('videoFps'), `FPS: ${data.fps.toFixed(1)}`);
                setTextContent(document.getElementById('metricFPS'), data.fps.toFixed(1));
            }

            // Update latency
            if (data.latency_ms !== undefined) {
                setTextContent(document.getElementById('videoLatency'), `Latency: ${data.latency_ms}ms`);
            }

            // Update GPU
            if (data.gpu_utilization !== undefined) {
                setTextContent(document.getElementById('metricGPU'), `${data.gpu_utilization}%`);
                applyThreshold('metricGPU', data.gpu_utilization, THRESHOLDS.gpu_utilization.warning, THRESHOLDS.gpu_utilization.danger, true);
            }

            // Update memory
            if (data.system_memory_mb !== undefined) {
                const memoryGB = (data.system_memory_mb / 1024).toFixed(1);
                setTextContent(document.getElementById('metricMemory'), `${memoryGB} GB`);
                applyThreshold('metricMemory', data.system_memory_mb, THRESHOLDS.system_memory_mb.warning, THRESHOLDS.system_memory_mb.danger, true);
            }

            // Update temperature
            if (data.temperature_c !== undefined) {
                setTextContent(document.getElementById('metricTemp'), `${data.temperature_c}Â°C`);
                applyThreshold('metricTemp', data.temperature_c, THRESHOLDS.temperature_c.warning, THRESHOLDS.temperature_c.danger, true);
            }

            // PHASE 2: Update CPU
            if (data.cpu_utilization !== undefined) {
                setTextContent(document.getElementById('metricCPU'), `${data.cpu_utilization}%`);
                applyThreshold('metricCPU', data.cpu_utilization, THRESHOLDS.cpu_utilization.warning, THRESHOLDS.cpu_utilization.danger, true);
            }

            // PHASE 2: Add to historical data
            addMetricData({
                gpu_utilization: data.gpu_utilization || 0,
                system_memory_mb: data.system_memory_mb || 0,
                temperature_c: data.temperature_c || 0,
                cpu_utilization: data.cpu_utilization || 0
            });

            // PHASE 2: Check thresholds for alerts
            checkThresholds({
                gpu_utilization: data.gpu_utilization,
                system_memory_mb: data.system_memory_mb,
                temperature_c: data.temperature_c,
                cpu_utilization: data.cpu_utilization
            });
        }

        function applyThreshold(elementId, value, warningThreshold, dangerThreshold, inverse = false) {
            const element = document.getElementById(elementId);
            element.classList.remove('warning', 'danger');

            if (inverse) {
                // For metrics where higher is worse
                if (value >= dangerThreshold) {
                    element.classList.add('danger');
                } else if (value >= warningThreshold) {
                    element.classList.add('warning');
                }
            } else {
                // For metrics where lower is worse
                if (value <= dangerThreshold) {
                    element.classList.add('danger');
                } else if (value <= warningThreshold) {
                    element.classList.add('warning');
                }
            }
        }

        // ================================================================
        // WCB API INTEGRATION
        // ================================================================
        async function executeMood(moodId, priority = 7) {
            try {
                const moodName = MOODS.find(m => m.id === moodId)?.name || `Mood ${moodId}`;
                showToast(`Executing ${moodName}...`, 'success', 3000);

                const response = await secureFetch(`${WCB_API_URL}/api/wcb/mood/execute`, {
                    method: 'POST',
                    body: JSON.stringify({ mood_id: moodId, priority: priority })
                });

                if (!response) {
                    showToast('Authentication required', 'error', 5000);
                    return;
                }

                const result = await response.json();

                if (response.ok) {
                    highlightActiveMood(moodId);
                    console.log(`âœ… Mood executed: ${result.mood}`);
                    showAlert(`Executing: ${result.mood}`, 'success', null, null, null, 3000);
                } else {
                    showToast(`Error: ${result.detail || 'Mood execution failed'}`, 'error', 5000);
                }
            } catch (error) {
                console.error('Mood execution error:', error);
                showToast(`API Error: ${error.message}`, 'error', 5000);
            }
        }

        async function executeAnimation(animationId) {
            try {
                const animName = ANIMATIONS.find(a => a.id === animationId)?.name || `Animation ${animationId}`;
                showToast(`Executing ${animName}...`, 'success', 3000);

                const response = await secureFetch(`${WCB_API_URL}/api/wcb/animation/execute`, {
                    method: 'POST',
                    body: JSON.stringify({ animation_id: animationId })
                });

                if (!response) return;

                const result = await response.json();

                if (response.ok) {
                    console.log(`âœ… Animation executed: ${result.animation}`);
                    showAlert(`Animation: ${result.animation}`, 'success', null, null, null, 3000);
                }
            } catch (error) {
                console.error('Animation execution error:', error);
            }
        }

        function highlightActiveMood(moodId) {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const button = document.querySelector(`[data-mood="${moodId}"]`);
            if (button) button.classList.add('active');
        }

        async function pollMoodStatus() {
            try {
                const response = await secureFetch(`${WCB_API_URL}/api/wcb/mood/status`);
                if (!response) return;

                const status = await response.json();

                if (status.active) {
                    setTextContent(document.getElementById('currentMood'), status.mood);
                    setTextContent(document.getElementById('moodProgress'), `${status.progress_percent || 0}%`);
                    document.getElementById('moodProgressFill').style.width = `${status.progress_percent || 0}%`;
                } else {
                    setTextContent(document.getElementById('currentMood'), 'Idle');
                    setTextContent(document.getElementById('moodProgress'), '0%');
                    document.getElementById('moodProgressFill').style.width = '0%';

                    // Clear active mood buttons
                    document.querySelectorAll('.mood-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                }
            } catch (error) {
                // Silently fail - polling happens frequently
            }
        }

        async function checkWCBHealth() {
            try {
                const response = await secureFetch(`${WCB_API_URL}/api/wcb/health`);
                if (response && response.ok) {
                    wcbConnected = true;
                } else {
                    wcbConnected = false;
                }
            } catch (error) {
                wcbConnected = false;
            }
            updateConnectionStatus();
        }

        function executeEmergencyStop() {
            if (confirm('Are you sure you want to execute EMERGENCY STOP?')) {
                executeMood(27, 10); // Mood 27 = Emergency Panic, Priority 10
                showAlert('EMERGENCY STOP EXECUTED', 'error', null, null, null, 10000);
            }
        }

        // ================================================================
        // UI UTILITIES
        // ================================================================
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');

            if (visionConnected && wcbConnected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<div class="connection-status-dot"></div><span>CONNECTED (Vision + WCB)</span>';
            } else if (visionConnected || wcbConnected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = `<div class="connection-status-dot"></div><span>CONNECTED (${visionConnected ? 'Vision' : 'WCB'} Only)</span>`;
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<div class="connection-status-dot"></div><span>DISCONNECTED</span>';
            }
        }

        function showAlert(message, type = 'info', metric = null, value = null, threshold = null, duration = null) {
            const alertPanel = document.getElementById('alertPanel');

            // Create alert element
            const alert = createSafeElement('div', { className: `alert ${type}` });

            // Icon
            const icon = createSafeElement('span', { className: 'alert-icon' });
            const icons = {
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };
            setTextContent(icon, icons[type] || icons.info);

            // Content
            const content = createSafeElement('div', { className: 'alert-content' });

            // Title (metric name if available)
            if (metric) {
                const title = createSafeElement('div', { className: 'alert-title' });
                const metricNames = {
                    'gpu_utilization': 'GPU Utilization Alert',
                    'temperature_c': 'Temperature Alert',
                    'system_memory_mb': 'Memory Alert',
                    'cpu_utilization': 'CPU Utilization Alert'
                };
                setTextContent(title, metricNames[metric] || 'System Alert');
                content.appendChild(title);
            }

            // Message
            const messageEl = createSafeElement('div', { className: 'alert-message' });
            setTextContent(messageEl, message);
            content.appendChild(messageEl);

            // Timestamp
            const timestamp = createSafeElement('div', { className: 'alert-timestamp' });
            const now = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            setTextContent(timestamp, now);
            content.appendChild(timestamp);

            alert.appendChild(icon);
            alert.appendChild(content);

            // Click to dismiss
            alert.onclick = () => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            };

            alertPanel.insertBefore(alert, alertPanel.firstChild);

            // Auto-dismiss with configurable duration
            const autoDismissTime = duration || (type === 'error' ? 10000 : 5000);
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        if (alert.parentNode) alert.remove();
                    }, 300);
                }
            }, autoDismissTime);

            // Limit to max 5 visible alerts
            while (alertPanel.children.length > 5) {
                alertPanel.lastChild.remove();
            }
        }

        function showToast(message, type = 'success', duration = 3000) {
            if (typeof toastManager !== 'undefined') {
                toastManager.show(message, type, duration);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // ================================================================
        // CLEANUP ON PAGE UNLOAD
        // ================================================================
        window.addEventListener('beforeunload', () => {
            console.log('Cleaning up dashboard resources...');
            if (visionWs && visionWs.readyState === WebSocket.OPEN) {
                visionWs.close();
            }
            if (typeof resourceManager !== 'undefined') {
                resourceManager.cleanupAll();
            }
        });

        console.log('âœ“ R2D2 Production Dashboard Phase 2 with Alert System loaded successfully');
    </script>
</body>
</html>
