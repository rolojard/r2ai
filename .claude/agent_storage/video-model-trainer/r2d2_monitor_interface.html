<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2D2 Vision System Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #001122, #003344);
            padding: 10px 20px;
            border-bottom: 2px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #00ff00;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            height: calc(100vh - 60px);
            gap: 2px;
        }

        .video-panel {
            background: #111;
            border: 2px solid #333;
            position: relative;
            overflow: hidden;
        }

        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(1.1) contrast(1.1);
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .control-panel {
            background: #0d1117;
            border: 2px solid #333;
            padding: 15px;
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 20px;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
        }

        .section-title {
            color: #ffff00;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }

        .metric-label {
            color: #aaa;
        }

        .metric-value {
            color: #00ff00;
            font-weight: bold;
        }

        .metric-value.warning {
            color: #ffaa00;
        }

        .metric-value.critical {
            color: #ff0000;
        }

        .detection-card {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 3px;
            padding: 8px;
            margin: 5px 0;
            font-size: 11px;
        }

        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .guest-id {
            color: #00ffff;
            font-weight: bold;
        }

        .costume-tag {
            background: #333;
            color: #ffff00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        .detection-details {
            color: #ccc;
            line-height: 1.3;
        }

        .zone-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .zone-immediate { background: #ff0000; }
        .zone-close { background: #ff9900; }
        .zone-medium { background: #ffff00; }
        .zone-far { background: #00ff00; }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .control-btn {
            background: #1a472a;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 12px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #00ff00;
            color: #000;
        }

        .control-btn.active {
            background: #00ff00;
            color: #000;
        }

        .alert-panel {
            background: #2a1a1a;
            border: 1px solid #ff4444;
            border-radius: 3px;
            padding: 8px;
            margin: 5px 0;
        }

        .alert-message {
            font-size: 11px;
            color: #ff6666;
        }

        .alert-time {
            font-size: 10px;
            color: #aaa;
            margin-top: 3px;
        }

        .fps-meter {
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            height: 8px;
            border-radius: 4px;
            position: relative;
            margin: 5px 0;
        }

        .fps-indicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 3px;
            background: #fff;
            border-radius: 1px;
            transition: left 0.3s;
        }

        .connection-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .connection-status.connected {
            background: #1a472a;
            border: 1px solid #00ff00;
            color: #00ff00;
        }

        .connection-status.disconnected {
            background: #472a1a;
            border: 1px solid #ff0000;
            color: #ff0000;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0a0a0a;
            padding: 5px 20px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #666;
            text-align: center;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">R2D2 VISION SYSTEM MONITOR</div>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">CONNECTING...</span>
        </div>
    </div>

    <div class="main-container">
        <div class="video-panel">
            <canvas id="videoCanvas" class="video-feed"></canvas>
            <div class="video-overlay" id="videoOverlay"></div>
        </div>

        <div class="control-panel">
            <div class="connection-status disconnected" id="connectionStatus">
                DISCONNECTED
            </div>

            <div class="panel-section">
                <div class="section-title">System Performance</div>
                <div class="metric-row">
                    <span class="metric-label">FPS:</span>
                    <span class="metric-value" id="fps">0.0</span>
                </div>
                <div class="fps-meter">
                    <div class="fps-indicator" id="fpsIndicator"></div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Inference:</span>
                    <span class="metric-value" id="inferenceTime">0.0ms</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Queue Size:</span>
                    <span class="metric-value" id="queueSize">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Detections:</span>
                    <span class="metric-value" id="activeDetections">0</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">System Resources</div>
                <div class="metric-row">
                    <span class="metric-label">CPU Usage:</span>
                    <span class="metric-value" id="cpuUsage">0.0%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">GPU Usage:</span>
                    <span class="metric-value" id="gpuUsage">0.0%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Memory:</span>
                    <span class="metric-value" id="memoryUsage">0.0%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Temperature:</span>
                    <span class="metric-value" id="temperature">0.0Â°C</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Current Detections</div>
                <div id="detectionsContainer">
                    <div class="detection-card">
                        <div style="text-align: center; color: #666; font-style: italic;">
                            No active detections
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">System Alerts</div>
                <div id="alertsContainer">
                    <div style="text-align: center; color: #666; font-style: italic;">
                        No alerts
                    </div>
                </div>
            </div>

            <div class="control-buttons">
                <button class="control-btn" onclick="requestScreenshot()">Screenshot</button>
                <button class="control-btn" onclick="toggleDetectionDisplay()">Toggle Overlay</button>
                <button class="control-btn" onclick="clearAlerts()">Clear Alerts</button>
                <button class="control-btn" onclick="reconnect()">Reconnect</button>
            </div>
        </div>
    </div>

    <div class="footer">
        R2D2 Vision System Monitor v1.0 | Last Update: <span id="lastUpdate">Never</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script>
        // Global variables
        let socket = null;
        let isConnected = false;
        let showDetectionOverlay = true;
        let canvas = null;
        let ctx = null;
        let alerts = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            initializeWebSocket();
            startHeartbeat();
        });

        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.hostname}:8765`;

            try {
                socket = io(wsUrl, {
                    transports: ['websocket'],
                    timeout: 5000
                });

                socket.on('connect', function() {
                    console.log('Connected to R2D2 Vision System');
                    updateConnectionStatus(true);
                });

                socket.on('disconnect', function() {
                    console.log('Disconnected from R2D2 Vision System');
                    updateConnectionStatus(false);
                });

                socket.on('status_update', function(data) {
                    updateSystemStatus(data);
                });

                socket.on('detection_update', function(data) {
                    updateDetections(data);
                    if (data.frame) {
                        displayVideoFrame(data.frame);
                    }
                });

                socket.on('screenshot', function(data) {
                    downloadScreenshot(data.image);
                });

                socket.on('connect_error', function(error) {
                    console.error('Connection error:', error);
                    updateConnectionStatus(false);
                });

            } catch (error) {
                console.error('Failed to initialize WebSocket:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const connectionStatus = document.getElementById('connectionStatus');

            if (connected) {
                statusDot.classList.add('active');
                statusText.textContent = 'CONNECTED';
                connectionStatus.textContent = 'CONNECTED';
                connectionStatus.className = 'connection-status connected';
            } else {
                statusDot.classList.remove('active');
                statusText.textContent = 'DISCONNECTED';
                connectionStatus.textContent = 'DISCONNECTED';
                connectionStatus.className = 'connection-status disconnected';
            }
        }

        function updateSystemStatus(status) {
            // Update performance metrics
            document.getElementById('fps').textContent = status.fps?.toFixed(1) || '0.0';
            document.getElementById('inferenceTime').textContent =
                `${status.inference_time_ms?.toFixed(1) || '0.0'}ms`;
            document.getElementById('queueSize').textContent = status.queue_size || '0';
            document.getElementById('activeDetections').textContent = status.active_detections || '0';

            // Update resource metrics
            updateMetricWithWarning('cpuUsage', status.cpu_usage, '%', 80, 90);
            updateMetricWithWarning('gpuUsage', status.gpu_usage, '%', 90, 95);
            updateMetricWithWarning('memoryUsage', status.memory_usage, '%', 80, 90);
            updateMetricWithWarning('temperature', status.temperature, 'Â°C', 75, 85);

            // Update FPS indicator
            updateFpsIndicator(status.fps || 0);

            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Check for alerts
            checkSystemAlerts(status);
        }

        function updateMetricWithWarning(elementId, value, unit, warningThreshold, criticalThreshold) {
            const element = document.getElementById(elementId);
            const displayValue = `${value?.toFixed(1) || '0.0'}${unit}`;

            element.textContent = displayValue;
            element.className = 'metric-value';

            if (value >= criticalThreshold) {
                element.classList.add('critical');
            } else if (value >= warningThreshold) {
                element.classList.add('warning');
            }
        }

        function updateFpsIndicator(fps) {
            const indicator = document.getElementById('fpsIndicator');
            const maxFps = 30;
            const percentage = Math.min(fps / maxFps, 1);
            indicator.style.left = `${percentage * 100}%`;
        }

        function updateDetections(data) {
            const container = document.getElementById('detectionsContainer');
            const detections = data.detections || [];

            if (detections.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; font-style: italic;">
                        No active detections
                    </div>
                `;
                return;
            }

            let html = '';
            detections.forEach((detection, index) => {
                const zoneClass = `zone-${detection.distance_zone}`;
                html += `
                    <div class="detection-card">
                        <div class="detection-header">
                            <span class="guest-id">${detection.guest_id}</span>
                            <span class="costume-tag">${detection.costume}</span>
                        </div>
                        <div class="detection-details">
                            <div>
                                <span class="zone-indicator ${zoneClass}"></span>
                                Zone: ${detection.distance_zone}
                            </div>
                            <div>Confidence: ${(detection.confidence * 100).toFixed(1)}%</div>
                            ${detection.face_recognition ?
                                `<div>Recognized: ${detection.face_recognition}</div>` : ''}
                            ${detection.interaction_count > 0 ?
                                `<div>Visits: ${detection.interaction_count}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayVideoFrame(base64Image) {
            if (!showDetectionOverlay) return;

            const img = new Image();
            img.onload = function() {
                // Resize canvas to match image
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw image on canvas
                ctx.drawImage(img, 0, 0);
            };
            img.src = `data:image/jpeg;base64,${base64Image}`;
        }

        function checkSystemAlerts(status) {
            const newAlerts = [];

            // Performance alerts
            if (status.fps < 20) {
                newAlerts.push({
                    type: 'warning',
                    message: `Low FPS: ${status.fps?.toFixed(1)}`,
                    time: new Date()
                });
            }

            if (status.inference_time_ms > 100) {
                newAlerts.push({
                    type: 'warning',
                    message: `High inference time: ${status.inference_time_ms?.toFixed(1)}ms`,
                    time: new Date()
                });
            }

            // Resource alerts
            if (status.cpu_usage > 90) {
                newAlerts.push({
                    type: 'critical',
                    message: `High CPU usage: ${status.cpu_usage?.toFixed(1)}%`,
                    time: new Date()
                });
            }

            if (status.temperature > 85) {
                newAlerts.push({
                    type: 'critical',
                    message: `High temperature: ${status.temperature?.toFixed(1)}Â°C`,
                    time: new Date()
                });
            }

            // Add new alerts
            newAlerts.forEach(alert => {
                alerts.unshift(alert);
            });

            // Keep only recent alerts (max 10)
            alerts = alerts.slice(0, 10);

            updateAlertsDisplay();
        }

        function updateAlertsDisplay() {
            const container = document.getElementById('alertsContainer');

            if (alerts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; font-style: italic;">
                        No alerts
                    </div>
                `;
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                html += `
                    <div class="alert-panel">
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-time">${alert.time.toLocaleTimeString()}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function requestScreenshot() {
            if (socket && isConnected) {
                socket.emit('request_screenshot');
            }
        }

        function downloadScreenshot(base64Image) {
            const link = document.createElement('a');
            link.href = `data:image/jpeg;base64,${base64Image}`;
            link.download = `r2d2_screenshot_${new Date().getTime()}.jpg`;
            link.click();
        }

        function toggleDetectionDisplay() {
            showDetectionOverlay = !showDetectionOverlay;
            const button = event.target;

            if (showDetectionOverlay) {
                button.classList.remove('active');
                button.textContent = 'Hide Overlay';
            } else {
                button.classList.add('active');
                button.textContent = 'Show Overlay';
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function clearAlerts() {
            alerts = [];
            updateAlertsDisplay();
        }

        function reconnect() {
            if (socket) {
                socket.disconnect();
            }
            setTimeout(() => {
                initializeWebSocket();
            }, 1000);
        }

        function startHeartbeat() {
            setInterval(() => {
                if (socket && isConnected) {
                    socket.emit('ping');
                }
            }, 30000); // Ping every 30 seconds
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            // Adjust canvas size if needed
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 's':
                case 'S':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        requestScreenshot();
                    }
                    break;
                case 'r':
                case 'R':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        reconnect();
                    }
                    break;
                case 'c':
                case 'C':
                    if (event.ctrlKey && event.shiftKey) {
                        event.preventDefault();
                        clearAlerts();
                    }
                    break;
            }
        });
    </script>
</body>
</html>