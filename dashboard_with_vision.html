<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2D2 Multi-Agent Dashboard with Real-time Vision</title>
    <style>
        /* ========== Base Styles ========== */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f172a;
            color: #f8fafc;
        }

        /* ========== Layout ========== */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .system-section {
            display: grid;
            grid-template-rows: auto auto auto;
            gap: 20px;
        }
        .control-sections {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ========== Cards & Containers ========== */
        .status-card, .vision-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
        }

        /* ========== Common Components ========== */
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .value, .stat-value {
            font-weight: bold;
            color: #10b981;
        }
        .stat-value {
            font-size: 24px;
        }
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
        }

        /* ========== Buttons ========== */
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* ========== Alerts & Status ========== */
        .alert, .success, .info {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .alert {
            background: #dc2626;
        }
        .success {
            background: #16a34a;
        }
        .info {
            background: #0ea5e9;
        }
        #connectionStatus {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 5px;
            background: #dc2626;
            z-index: 1000;
        }
        #connectionStatus.connected {
            background: #16a34a;
        }

        /* ========== Vision System ========== */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-feed {
            width: 100%;
            height: auto;
            display: block;
            transform: translateZ(0);
            will-change: transform;
            image-rendering: optimizeQuality;
            object-fit: contain;
            transition: opacity 0.1s ease-in-out;
        }
        /* Performance Monitoring Styles */
        .performance-monitor {
            background: #0f172a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .performance-metric {
            background: #1e293b;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border-left: 3px solid #64748b;
        }
        .performance-metric.good {
            border-left-color: #10b981;
        }
        .performance-metric.warning {
            border-left-color: #f59e0b;
        }
        .performance-metric.bad {
            border-left-color: #ef4444;
        }
        .performance-value {
            font-size: 20px;
            font-weight: bold;
            color: #10b981;
        }
        .performance-metric.warning .performance-value {
            color: #f59e0b;
        }
        .performance-metric.bad .performance-value {
            color: #ef4444;
        }
        .performance-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .ws-health-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            margin-left: 8px;
            animation: pulse 2s ease-in-out infinite;
        }
        .ws-health-indicator.healthy {
            background: #10b981;
        }
        .ws-health-indicator.degraded {
            background: #f59e0b;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .no-video {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background: #000;
            color: #64748b;
            border-radius: 8px;
            font-size: 18px;
        }
        #visionConnectionStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            background: #dc2626;
            color: white;
            font-size: 12px;
        }
        #visionConnectionStatus.connected {
            background: #16a34a;
        }
        .vision-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .vision-stat {
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .confidence-control {
            margin-top: 15px;
        }
        .confidence-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* ========== Detection Display ========== */
        .detection-info {
            margin-top: 15px;
        }
        .detection-list {
            max-height: 300px;
            overflow-y: auto;
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .detection-item {
            padding: 8px;
            margin: 5px 0;
            background: #1e293b;
            border-radius: 4px;
            border-left: 4px solid #10b981;
        }
        .detection-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .detection-confidence {
            color: #10b981;
        }
        .detection-coords {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* ========== Servo Control ========== */
        .servo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .servo-channel {
            background: #0f172a;
            padding: 15px;
            border-radius: 5px;
        }
        .servo-channel label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #94a3b8;
        }
        .servo-slider {
            width: 100%;
            margin: 10px 0;
        }
        .servo-value {
            color: #10b981;
            font-weight: bold;
            display: block;
            text-align: right;
        }
        .servo-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ========== Audio Control ========== */
        .audio-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .audio-category h4 {
            margin: 0 0 10px 0;
            color: #94a3b8;
        }
        .audio-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .audio-controls label {
            flex: 1;
            min-width: 200px;
        }
        .audio-queue, .queue-list {
            margin-top: 15px;
        }
        .queue-list {
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
        }

        /* ========== Character Recognition ========== */
        .character-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .character-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .character-stat {
            background: #0f172a;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .character-list h4, .character-history h4 {
            margin: 10px 0;
            color: #94a3b8;
        }
        .character-detections, .character-history-list {
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            max-height: 250px;
            overflow-y: auto;
        }
        .character-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        /* ========== Behavior Sequences ========== */
        .sequence-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .sequence-category h4 {
            margin: 0 0 10px 0;
            color: #94a3b8;
        }
        .sequence-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .sequence-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: #0f172a;
        }
        .sequence-btn:hover {
            background: #1e293b;
        }
        .sequence-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .sequence-duration {
            font-size: 12px;
            color: #94a3b8;
        }
        .create-btn {
            border: 2px dashed #334155;
        }
        .sequence-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .sequence-status {
            margin-top: 20px;
        }
        .current-sequence {
            margin-bottom: 10px;
        }
        .sequence-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .progress-bar {
            flex: 1;
            height: 8px;
            background: #0f172a;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 0.3s;
        }

        /* ========== Safety Dashboard ========== */
        .safety-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .safety-status h4, .safety-controls h4, .safety-diagnostics h4 {
            margin: 0 0 15px 0;
            color: #94a3b8;
        }
        .safety-indicators {
            display: grid;
            gap: 10px;
        }
        .safety-indicator {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            background: #0f172a;
            padding: 12px;
            border-radius: 5px;
        }
        .indicator-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #16a34a;
        }
        .status-text {
            color: #94a3b8;
        }
        .emergency-btn {
            width: 100%;
            background: #dc2626 !important;
            font-weight: bold;
            padding: 15px 20px;
            margin-bottom: 10px;
        }
        .emergency-btn:hover {
            background: #b91c1c !important;
        }
        .emergency-btn-small {
            background: #dc2626 !important;
        }
        .emergency-btn-small:hover {
            background: #b91c1c !important;
        }
        .diagnostic-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .diagnostic-results {
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .diagnostic-results h5 {
            margin: 0 0 10px 0;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="connectionStatus">Dashboard Disconnected</div>

    <div class="header">
        <h1>üéØ R2D2 Multi-Agent Dashboard with Real-time Vision</h1>
        <p>Real-time monitoring, control system, and live object detection</p>
    </div>

    <div class="main-container">
        <!-- Vision Section -->
        <div class="vision-section">
            <h3>üëÅÔ∏è Real-time Vision System</h3>
            <div id="visionConnectionStatus">Vision Disconnected</div>

            <div class="video-container">
                <img id="videoFeed" class="video-feed" style="display: none;" alt="Live video feed">
                <div id="noVideo" class="no-video">
                    <div>
                        <div>üì∑ Connecting to camera...</div>
                        <div style="font-size: 14px; margin-top: 10px;">Waiting for vision system</div>
                    </div>
                </div>
            </div>

            <div class="vision-stats">
                <div class="vision-stat">
                    <div class="stat-value" id="visionFPS">--</div>
                    <div class="stat-label">FPS</div>
                </div>
                <div class="vision-stat">
                    <div class="stat-value" id="detectionCount">--</div>
                    <div class="stat-label">Detections</div>
                </div>
                <div class="vision-stat">
                    <div class="stat-value" id="detectionTime">--</div>
                    <div class="stat-label">Detection Time (ms)</div>
                </div>
                <div class="vision-stat">
                    <div class="stat-value" id="totalDetections">--</div>
                    <div class="stat-label">Total Detected</div>
                </div>
            </div>

            <div class="confidence-control">
                <label for="confidenceSlider">Confidence Threshold: <span id="confidenceValue">0.5</span></label>
                <input type="range" id="confidenceSlider" class="confidence-slider"
                       min="0.1" max="1.0" step="0.05" value="0.5">
            </div>

            <div class="controls">
                <button onclick="toggleVisionSystem()">Start Vision</button>
                <button onclick="captureFrame()">Capture Frame</button>
                <button onclick="toggleDetectionDisplay()">Toggle Detections</button>
            </div>

            <div class="detection-info">
                <h4>Live Detections</h4>
                <div id="detectionList" class="detection-list">
                    <div style="text-align: center; color: #64748b;">No detections yet...</div>
                </div>
            </div>

            <!-- Performance Monitoring Section -->
            <div class="performance-monitor">
                <h4>Performance Monitor <span class="ws-health-indicator" id="wsHealthIndicator"></span></h4>
                <div class="performance-grid">
                    <div class="performance-metric" id="actualFpsMetric">
                        <div class="performance-value" id="actualFps">--</div>
                        <div class="performance-label">Actual FPS</div>
                    </div>
                    <div class="performance-metric" id="frameVarianceMetric">
                        <div class="performance-value" id="frameVariance">--%</div>
                        <div class="performance-label">Frame Variance</div>
                    </div>
                    <div class="performance-metric" id="wsLatencyMetric">
                        <div class="performance-value" id="wsLatency">-- ms</div>
                        <div class="performance-label">WS Latency</div>
                    </div>
                    <div class="performance-metric" id="msgQueueMetric">
                        <div class="performance-value" id="msgQueue">0</div>
                        <div class="performance-label">Message Queue</div>
                    </div>
                    <div class="performance-metric" id="droppedFramesMetric">
                        <div class="performance-value" id="droppedFrames">0</div>
                        <div class="performance-label">Dropped Frames</div>
                    </div>
                    <div class="performance-metric" id="targetFpsMetric">
                        <div class="performance-value" id="targetFps">15</div>
                        <div class="performance-label">Target FPS</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Section -->
        <div class="system-section">
            <div class="status-card">
                <h3>üñ•Ô∏è System Performance</h3>
                <div class="metric">
                    <span>CPU Usage:</span>
                    <span class="value" id="cpuUsage">--%</span>
                </div>
                <div class="metric">
                    <span>Memory Usage:</span>
                    <span class="value" id="memoryUsage">--%</span>
                </div>
                <div class="metric">
                    <span>Temperature:</span>
                    <span class="value" id="temperature">--¬∞C</span>
                </div>
                <div class="metric">
                    <span>GPU Usage:</span>
                    <span class="value" id="gpuUsage">--%</span>
                </div>
            </div>

            <div class="status-card">
                <h3>üé≠ R2D2 Status</h3>
                <div class="metric">
                    <span>Active Servos:</span>
                    <span class="value" id="activeServos">--</span>
                </div>
                <div class="metric">
                    <span>Audio System:</span>
                    <span class="value" id="audioStatus">--</span>
                </div>
                <div class="metric">
                    <span>Vision System:</span>
                    <span class="value" id="visionStatus">--</span>
                </div>
                <div class="metric">
                    <span>System Health:</span>
                    <span class="value" id="systemHealth">--%</span>
                </div>
            </div>

            <div class="status-card">
                <h3>üé™ Performance Metrics</h3>
                <div class="metric">
                    <span>Servo Timing:</span>
                    <span class="value" id="servoTiming">-- ms</span>
                </div>
                <div class="metric">
                    <span>Audio Latency:</span>
                    <span class="value" id="audioLatency">-- ms</span>
                </div>
                <div class="metric">
                    <span>Vision Inference:</span>
                    <span class="value" id="visionInference">-- ms</span>
                </div>
                <div class="metric">
                    <span>Uptime:</span>
                    <span class="value" id="uptime">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Control Sections -->
    <div class="control-sections">
        <!-- Servo Control Matrix -->
        <div class="status-card servo-control-section">
            <h3>‚öôÔ∏è Servo Control Matrix - Pololu Maestro Mini 12</h3>
            <div class="servo-grid">
                <div class="servo-channel" data-channel="0">
                    <label>Dome Rotation</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(0, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="1">
                    <label>Head Tilt</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(1, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="2">
                    <label>Periscope</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(2, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="3">
                    <label>Radar Eye</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(3, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="4">
                    <label>Panel 1</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(4, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="5">
                    <label>Panel 2</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(5, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="6">
                    <label>Panel 3</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(6, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="7">
                    <label>Panel 4</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(7, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="8">
                    <label>Utility Arm 1</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(8, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="9">
                    <label>Utility Arm 2</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(9, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="10">
                    <label>Interface Arm</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(10, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="11">
                    <label>Gripper</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(11, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
            </div>
            <div class="servo-controls">
                <button onclick="homeAllServos()">Home All</button>
                <button onclick="enableAllServos()">Enable All</button>
                <button onclick="disableAllServos()">Disable All</button>
                <button onclick="saveServoPreset()">Save Preset</button>
                <button onclick="loadServoPreset()">Load Preset</button>
            </div>
        </div>

        <!-- Audio Control Panel -->
        <div class="status-card audio-control-section">
            <h3>üîä Audio Control Panel - R2D2 Sound Effects</h3>
            <div class="audio-grid">
                <div class="audio-category">
                    <h4>Emotional Responses</h4>
                    <div class="audio-buttons">
                        <button onclick="playSound('happy')">Happy/Excited</button>
                        <button onclick="playSound('sad')">Sad/Worried</button>
                        <button onclick="playSound('curious')">Curious</button>
                        <button onclick="playSound('frustrated')">Frustrated</button>
                        <button onclick="playSound('surprised')">Surprised</button>
                        <button onclick="playSound('playful')">Playful</button>
                    </div>
                </div>
                <div class="audio-category">
                    <h4>Character Interactions</h4>
                    <div class="audio-buttons">
                        <button onclick="playSound('greeting')">Greeting</button>
                        <button onclick="playSound('chatting')">Chatting</button>
                        <button onclick="playSound('sarcastic')">Sarcastic</button>
                        <button onclick="playSound('affection')">Affectionate</button>
                        <button onclick="playSound('stubborn')">Stubborn</button>
                        <button onclick="playSound('alert')">Alert/Warning</button>
                    </div>
                </div>
                <div class="audio-category">
                    <h4>Star Wars Specific</h4>
                    <div class="audio-buttons">
                        <button onclick="playSound('jedi_recognition')">Jedi Recognition</button>
                        <button onclick="playSound('princess_leia')">Princess Leia Message</button>
                        <button onclick="playSound('astromech_duties')">Astromech Duties</button>
                        <button onclick="playSound('power_up')">Power Up</button>
                        <button onclick="playSound('memory_wipe')">Memory Wipe</button>
                        <button onclick="playSound('musical')">Musical Entertainment</button>
                    </div>
                </div>
            </div>
            <div class="audio-controls">
                <label for="volumeSlider">Volume: <span id="volumeValue">75</span>%</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="75"
                       onchange="updateVolume(this.value)">
                <button onclick="stopAllAudio()">Stop All</button>
                <button onclick="muteAudio()">Mute</button>
            </div>
            <div class="audio-queue">
                <h4>Audio Queue</h4>
                <div id="audioQueue" class="queue-list">
                    <div style="text-align: center; color: #64748b;">No sounds queued</div>
                </div>
            </div>
        </div>

        <!-- Character Recognition Panel -->
        <div class="status-card character-recognition-section">
            <h3>üé≠ Character Recognition Display</h3>
            <div class="character-grid">
                <div class="character-stats">
                    <div class="character-stat">
                        <div class="stat-value" id="recognizedCharacters">--</div>
                        <div class="stat-label">Recognized Characters</div>
                    </div>
                    <div class="character-stat">
                        <div class="stat-value" id="confidenceLevel">--%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="character-stat">
                        <div class="stat-value" id="recognitionTime">--</div>
                        <div class="stat-label">Recognition Time (ms)</div>
                    </div>
                </div>
                <div class="character-list">
                    <h4>Current Characters</h4>
                    <div id="characterList" class="character-detections">
                        <div style="text-align: center; color: #64748b;">No characters detected</div>
                    </div>
                </div>
                <div class="character-history">
                    <h4>Recent History</h4>
                    <div id="characterHistory" class="character-history-list">
                        <div style="text-align: center; color: #64748b;">No history available</div>
                    </div>
                </div>
            </div>
            <div class="character-controls">
                <button onclick="enableCharacterRecognition()">Enable Recognition</button>
                <button onclick="disableCharacterRecognition()">Disable Recognition</button>
                <button onclick="clearCharacterHistory()">Clear History</button>
                <button onclick="exportCharacterData()">Export Data</button>
            </div>
        </div>

        <!-- Behavior Sequences Library -->
        <div class="status-card behavior-sequences-section">
            <h3>üé™ Behavior Sequences Library</h3>
            <div class="sequence-grid">
                <div class="sequence-category">
                    <h4>Emotional Sequences</h4>
                    <div class="sequence-buttons">
                        <button onclick="playSequence('excited')" class="sequence-btn">
                            <span class="sequence-name">Excited</span>
                            <span class="sequence-duration">4s</span>
                        </button>
                        <button onclick="playSequence('curious')" class="sequence-btn">
                            <span class="sequence-name">Curious</span>
                            <span class="sequence-duration">3s</span>
                        </button>
                        <button onclick="playSequence('frustrated')" class="sequence-btn">
                            <span class="sequence-name">Frustrated</span>
                            <span class="sequence-duration">5s</span>
                        </button>
                        <button onclick="playSequence('happy')" class="sequence-btn">
                            <span class="sequence-name">Happy</span>
                            <span class="sequence-duration">3s</span>
                        </button>
                    </div>
                </div>
                <div class="sequence-category">
                    <h4>Functional Sequences</h4>
                    <div class="sequence-buttons">
                        <button onclick="playSequence('scanning')" class="sequence-btn">
                            <span class="sequence-name">Scanning</span>
                            <span class="sequence-duration">6s loop</span>
                        </button>
                        <button onclick="playSequence('maintenance')" class="sequence-btn">
                            <span class="sequence-name">Maintenance</span>
                            <span class="sequence-duration">8s</span>
                        </button>
                        <button onclick="playSequence('greeting')" class="sequence-btn">
                            <span class="sequence-name">Greeting</span>
                            <span class="sequence-duration">4s</span>
                        </button>
                        <button onclick="playSequence('demonstration')" class="sequence-btn">
                            <span class="sequence-name">Demonstration</span>
                            <span class="sequence-duration">12s</span>
                        </button>
                    </div>
                </div>
                <div class="sequence-category">
                    <h4>Custom Sequences</h4>
                    <div class="sequence-buttons">
                        <button onclick="playSequence('user_defined_1')" class="sequence-btn">
                            <span class="sequence-name">Custom 1</span>
                            <span class="sequence-duration">--</span>
                        </button>
                        <button onclick="playSequence('user_defined_2')" class="sequence-btn">
                            <span class="sequence-name">Custom 2</span>
                            <span class="sequence-duration">--</span>
                        </button>
                        <button onclick="createCustomSequence()" class="sequence-btn create-btn">
                            <span class="sequence-name">Create New</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="sequence-controls">
                <button onclick="stopCurrentSequence()">Stop Current</button>
                <button onclick="pauseCurrentSequence()">Pause</button>
                <button onclick="resumeCurrentSequence()">Resume</button>
                <select id="sequenceSpeed" onchange="updateSequenceSpeed(this.value)">
                    <option value="0.5">0.5x Speed</option>
                    <option value="1.0" selected>Normal Speed</option>
                    <option value="1.5">1.5x Speed</option>
                    <option value="2.0">2x Speed</option>
                </select>
            </div>
            <div class="sequence-status">
                <div class="current-sequence">
                    <span>Current: </span><span id="currentSequence">None</span>
                </div>
                <div class="sequence-progress">
                    <span>Progress: </span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="sequenceProgress"></div>
                    </div>
                    <span id="sequenceTime">0:00 / 0:00</span>
                </div>
            </div>
        </div>

        <!-- Safety Dashboard -->
        <div class="status-card safety-dashboard-section">
            <h3>üõ°Ô∏è Safety Dashboard</h3>
            <div class="safety-grid">
                <div class="safety-status">
                    <h4>System Status</h4>
                    <div class="safety-indicators">
                        <div class="safety-indicator" id="servoSafety">
                            <span class="indicator-light"></span>
                            <span>Servo Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                        <div class="safety-indicator" id="audioSafety">
                            <span class="indicator-light"></span>
                            <span>Audio Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                        <div class="safety-indicator" id="visionSafety">
                            <span class="indicator-light"></span>
                            <span>Vision Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                        <div class="safety-indicator" id="powerSafety">
                            <span class="indicator-light"></span>
                            <span>Power Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                    </div>
                </div>
                <div class="safety-controls">
                    <h4>Emergency Controls</h4>
                    <button onclick="emergencyStopAll()" class="emergency-btn">
                        üö® EMERGENCY STOP ALL
                    </button>
                    <button onclick="emergencyStopServos()" class="emergency-btn-small">
                        Stop Servos
                    </button>
                    <button onclick="emergencyStopAudio()" class="emergency-btn-small">
                        Stop Audio
                    </button>
                    <button onclick="softShutdown()" class="emergency-btn-small">
                        Soft Shutdown
                    </button>
                </div>
                <div class="safety-diagnostics">
                    <h4>Diagnostics</h4>
                    <div class="diagnostic-tests">
                        <button onclick="runDiagnostic('servo')">Test Servos</button>
                        <button onclick="runDiagnostic('audio')">Test Audio</button>
                        <button onclick="runDiagnostic('vision')">Test Vision</button>
                        <button onclick="runDiagnostic('communication')">Test Comms</button>
                        <button onclick="runDiagnostic('full')">Full System Test</button>
                    </div>
                    <div class="diagnostic-results">
                        <h5>Last Test Results</h5>
                        <div id="diagnosticResults">
                            <div style="text-align: center; color: #64748b;">No tests run</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-card">
        <h3>üéÆ Control Panel</h3>
        <div class="controls">
            <button onclick="testServos()">Test Servos</button>
            <button onclick="testAudio()">Test Audio</button>
            <button onclick="testVision()">Test Vision</button>
            <button onclick="runFullDemo()">Full Demo</button>
            <button onclick="emergencyStop()">Emergency Stop</button>
        </div>
    </div>

    <div id="alerts"></div>

    <script>
        // ========== State Management ==========
        const DashboardState = {
            dashboardWs: null,
            dashboardReconnectInterval: null,
            visionWs: null,
            visionReconnectInterval: null,
            visionSystemActive: false,
            showDetections: true,
            lastFrameTime: 0,
            frameThrottleInterval: 1000 / 15, // Max 15 FPS display
            targetFPS: 15,
            pendingFrameUpdate: false,
            detectionStats: {
                totalFrames: 0,
                totalDetections: 0,
                avgFPS: 0
            },
            // Performance monitoring
            performanceMonitor: {
                frameTimestamps: [], // Circular buffer for frame timing
                maxFrameHistory: 30, // Track last 30 frames for variance calculation
                droppedFrames: 0,
                messageQueue: [],
                maxQueueSize: 10,
                lastMessageTime: 0,
                wsLatency: 0,
                reconnectAttempts: 0,
                reconnectBackoff: 1000, // Initial backoff: 1 second
                maxReconnectBackoff: 30000, // Max backoff: 30 seconds
                heartbeatInterval: null,
                lastHeartbeat: 0,
                missedHeartbeats: 0,
                maxMissedHeartbeats: 3
            },
            // Adaptive frame rate control
            adaptiveFrameRate: {
                enabled: true,
                currentFPS: 15,
                minFPS: 5,
                maxFPS: 30,
                adjustmentFactor: 0.1, // Gradual adjustment
                performanceThreshold: 0.15 // 15% variance threshold
            }
        };

        // ========== WebSocket Management ==========
        const WebSocketManager = {
            connectToDashboard() {
                try {
                    DashboardState.dashboardWs = new WebSocket('ws://localhost:8766');

                    DashboardState.dashboardWs.onopen = () => {
                        UIManager.updateConnectionStatus('Dashboard Connected', true);
                        clearInterval(DashboardState.dashboardReconnectInterval);
                        // Reset reconnection backoff on successful connection
                        DashboardState.performanceMonitor.reconnectAttempts = 0;
                        DashboardState.performanceMonitor.reconnectBackoff = 1000;
                        this.requestSystemData();
                        this.startHeartbeat();
                    };

                    DashboardState.dashboardWs.onmessage = (event) => {
                        // Track message latency
                        DashboardState.performanceMonitor.lastMessageTime = Date.now();
                        const data = JSON.parse(event.data);
                        MessageHandler.handleDashboardMessage(data);
                    };

                    DashboardState.dashboardWs.onclose = () => {
                        UIManager.updateConnectionStatus('Dashboard Disconnected', false);
                        this.stopHeartbeat();
                        this.attemptDashboardReconnect();
                    };

                    DashboardState.dashboardWs.onerror = (error) => {
                        console.error('Dashboard WebSocket error:', error);
                    };
                } catch (error) {
                    console.error('Dashboard connection failed:', error);
                    this.attemptDashboardReconnect();
                }
            },

            connectToVision() {
                if (DashboardState.visionWs && DashboardState.visionWs.readyState === WebSocket.OPEN) {
                    console.log('Vision WebSocket already connected');
                    return;
                }

                try {
                    DashboardState.visionWs = new WebSocket('ws://localhost:8767');

                    DashboardState.visionWs.onopen = () => {
                        UIManager.updateVisionConnectionStatus('Vision Connected', true);
                        clearInterval(DashboardState.visionReconnectInterval);
                        DashboardState.visionSystemActive = true;
                        // Reset reconnection state
                        DashboardState.performanceMonitor.reconnectAttempts = 0;
                        DashboardState.performanceMonitor.reconnectBackoff = 1000;
                        PerformanceMonitor.updateWSHealth('healthy');
                        UIManager.showAlert('Vision system connected', 'success');
                    };

                    DashboardState.visionWs.onmessage = (event) => {
                        // Queue message for processing to prevent blocking
                        const sentTime = Date.now();
                        this.queueMessage(event.data, sentTime);
                    };

                    DashboardState.visionWs.onclose = () => {
                        UIManager.updateVisionConnectionStatus('Vision Disconnected', false);
                        DashboardState.visionSystemActive = false;
                        VisionManager.hideVideo();
                        PerformanceMonitor.updateWSHealth('disconnected');
                        this.attemptVisionReconnect();
                    };

                    DashboardState.visionWs.onerror = (error) => {
                        console.error('Vision WebSocket error:', error);
                        PerformanceMonitor.updateWSHealth('error');
                    };
                } catch (error) {
                    console.error('Vision connection failed:', error);
                    this.attemptVisionReconnect();
                }
            },

            attemptDashboardReconnect() {
                if (!DashboardState.dashboardReconnectInterval) {
                    // Exponential backoff for reconnection
                    DashboardState.performanceMonitor.reconnectAttempts++;
                    const backoff = Math.min(
                        DashboardState.performanceMonitor.reconnectBackoff *
                        Math.pow(2, DashboardState.performanceMonitor.reconnectAttempts - 1),
                        DashboardState.performanceMonitor.maxReconnectBackoff
                    );

                    console.log(`Attempting dashboard reconnect in ${backoff}ms (attempt ${DashboardState.performanceMonitor.reconnectAttempts})`);

                    DashboardState.dashboardReconnectInterval = setTimeout(() => {
                        DashboardState.dashboardReconnectInterval = null;
                        this.connectToDashboard();
                    }, backoff);
                }
            },

            attemptVisionReconnect() {
                if (!DashboardState.visionReconnectInterval) {
                    // Exponential backoff for reconnection
                    DashboardState.performanceMonitor.reconnectAttempts++;
                    const backoff = Math.min(
                        DashboardState.performanceMonitor.reconnectBackoff *
                        Math.pow(2, DashboardState.performanceMonitor.reconnectAttempts - 1),
                        DashboardState.performanceMonitor.maxReconnectBackoff
                    );

                    console.log(`Attempting vision reconnect in ${backoff}ms (attempt ${DashboardState.performanceMonitor.reconnectAttempts})`);

                    DashboardState.visionReconnectInterval = setTimeout(() => {
                        DashboardState.visionReconnectInterval = null;
                        this.connectToVision();
                    }, backoff);
                }
            },

            // Message queue management to handle bursts
            queueMessage(data, receivedTime) {
                const queue = DashboardState.performanceMonitor.messageQueue;

                // Add message to queue
                queue.push({ data, receivedTime });

                // Process queue if not already processing
                if (!this.processingQueue) {
                    this.processMessageQueue();
                }

                // Maintain queue size limit
                if (queue.length > DashboardState.performanceMonitor.maxQueueSize) {
                    const dropped = queue.shift();
                    console.warn('Message queue full, dropping oldest message');
                }
            },

            processMessageQueue() {
                this.processingQueue = true;

                const processNext = () => {
                    const queue = DashboardState.performanceMonitor.messageQueue;

                    if (queue.length === 0) {
                        this.processingQueue = false;
                        return;
                    }

                    const { data, receivedTime } = queue.shift();
                    const processingTime = Date.now();

                    // Calculate latency
                    DashboardState.performanceMonitor.wsLatency = processingTime - receivedTime;

                    try {
                        const parsedData = JSON.parse(data);
                        MessageHandler.handleVisionMessage(parsedData);
                    } catch (error) {
                        console.error('Error processing queued message:', error);
                    }

                    // Update queue display
                    PerformanceMonitor.updateQueueDepth(queue.length);

                    // Process next message using requestAnimationFrame for smooth performance
                    if (queue.length > 0) {
                        requestAnimationFrame(processNext);
                    } else {
                        this.processingQueue = false;
                    }
                };

                processNext();
            },

            // Heartbeat mechanism for connection health
            startHeartbeat() {
                this.stopHeartbeat(); // Clear any existing heartbeat

                DashboardState.performanceMonitor.heartbeatInterval = setInterval(() => {
                    if (DashboardState.dashboardWs && DashboardState.dashboardWs.readyState === WebSocket.OPEN) {
                        try {
                            DashboardState.dashboardWs.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));

                            // Check for missed heartbeats
                            const now = Date.now();
                            if (DashboardState.performanceMonitor.lastHeartbeat > 0 &&
                                now - DashboardState.performanceMonitor.lastHeartbeat > 10000) { // 10 seconds
                                DashboardState.performanceMonitor.missedHeartbeats++;

                                if (DashboardState.performanceMonitor.missedHeartbeats >=
                                    DashboardState.performanceMonitor.maxMissedHeartbeats) {
                                    console.warn('Too many missed heartbeats, reconnecting...');
                                    this.stopHeartbeat();
                                    DashboardState.dashboardWs.close();
                                }
                            }

                            DashboardState.performanceMonitor.lastHeartbeat = now;
                        } catch (error) {
                            console.error('Heartbeat error:', error);
                        }
                    }
                }, 5000); // Send heartbeat every 5 seconds
            },

            stopHeartbeat() {
                if (DashboardState.performanceMonitor.heartbeatInterval) {
                    clearInterval(DashboardState.performanceMonitor.heartbeatInterval);
                    DashboardState.performanceMonitor.heartbeatInterval = null;
                }
            },

            requestSystemData() {
                if (DashboardState.dashboardWs && DashboardState.dashboardWs.readyState === WebSocket.OPEN) {
                    DashboardState.dashboardWs.send(JSON.stringify({type: 'request_data'}));
                }
            },

            sendCommand(command, params = {}) {
                if (DashboardState.dashboardWs && DashboardState.dashboardWs.readyState === WebSocket.OPEN) {
                    DashboardState.dashboardWs.send(JSON.stringify({type: 'command', command, params}));
                }
            }
        };

        // ========== Message Handlers ==========
        const MessageHandler = {
            handleDashboardMessage(data) {
                switch(data.type) {
                    case 'system_stats':
                        UIManager.updateSystemStats(data.stats);
                        break;
                    case 'r2d2_status':
                        UIManager.updateR2D2Status(data.status);
                        break;
                    case 'alert':
                        UIManager.showAlert(data.message, data.level);
                        break;
                }
            },

            handleVisionMessage(data) {
                switch(data.type) {
                    case 'connection_status':
                        UIManager.showAlert(data.message, 'info');
                        break;
                    case 'vision_data':
                        VisionManager.updateVisionDisplay(data);
                        break;
                    case 'character_vision_data':
                        VisionManager.updateVisionDisplay(data);
                        CharacterManager.updateCharacterDisplay(data);
                        break;
                    case 'heartbeat':
                        // Keep connection alive
                        break;
                }
            }
        };

        // ========== Vision Management ==========
        const VisionManager = {
            updateVisionDisplay(data) {
                const currentTime = Date.now();
                const timeSinceLastFrame = currentTime - DashboardState.lastFrameTime;

                // Adaptive frame rate control
                if (DashboardState.adaptiveFrameRate.enabled) {
                    const targetInterval = 1000 / DashboardState.adaptiveFrameRate.currentFPS;

                    if (timeSinceLastFrame < targetInterval || DashboardState.pendingFrameUpdate) {
                        // Track dropped frames for performance monitoring
                        DashboardState.performanceMonitor.droppedFrames++;
                        PerformanceMonitor.updateDroppedFrames(DashboardState.performanceMonitor.droppedFrames);
                        return; // Skip frame to maintain smooth display
                    }
                } else {
                    // Original throttle logic
                    if (timeSinceLastFrame < DashboardState.frameThrottleInterval || DashboardState.pendingFrameUpdate) {
                        DashboardState.performanceMonitor.droppedFrames++;
                        PerformanceMonitor.updateDroppedFrames(DashboardState.performanceMonitor.droppedFrames);
                        return;
                    }
                }

                // Record frame timestamp for variance calculation
                PerformanceMonitor.recordFrameTimestamp(currentTime);

                // Update video feed
                if (data.frame) {
                    this.updateVideoFrame(data.frame, currentTime);
                }

                // Update stats
                if (data.stats) {
                    this.updateVisionStats(data.stats);
                }

                // Update detections
                if (data.detections && DashboardState.showDetections) {
                    this.updateDetectionsList(data.detections);
                    document.getElementById('detectionCount').textContent = data.detections.length;
                }

                // Update detection stats
                DashboardState.detectionStats.totalFrames++;
                DashboardState.detectionStats.totalDetections += data.detections ? data.detections.length : 0;
            },

            updateVideoFrame(frameData, currentTime) {
                DashboardState.pendingFrameUpdate = true;
                const videoFeed = document.getElementById('videoFeed');
                const noVideo = document.getElementById('noVideo');

                const newImg = new Image();
                newImg.onload = function() {
                    requestAnimationFrame(() => {
                        videoFeed.src = this.src;
                        videoFeed.style.display = 'block';
                        noVideo.style.display = 'none';
                        DashboardState.lastFrameTime = currentTime;
                        DashboardState.pendingFrameUpdate = false;
                    });
                };
                newImg.onerror = () => {
                    DashboardState.pendingFrameUpdate = false;
                };
                newImg.src = 'data:image/jpeg;base64,' + frameData;
            },

            updateVisionStats(stats) {
                document.getElementById('visionFPS').textContent = stats.fps.toFixed(1);
                document.getElementById('detectionTime').textContent = (stats.detection_time * 1000).toFixed(1);
                document.getElementById('totalDetections').textContent = stats.total_detections;
                document.getElementById('visionInference').textContent = (stats.detection_time * 1000).toFixed(1) + ' ms';
            },

            updateDetectionsList(detections) {
                const detectionList = document.getElementById('detectionList');

                if (detections.length === 0) {
                    detectionList.innerHTML = '<div style="text-align: center; color: #64748b;">No detections in current frame</div>';
                    return;
                }

                let html = '';
                detections.forEach((detection) => {
                    const [x1, y1, x2, y2] = detection.bbox;
                    html += `
                        <div class="detection-item">
                            <div class="detection-header">
                                <span>${detection.class}</span>
                                <span class="detection-confidence">${(detection.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="detection-coords">
                                Box: (${Math.round(x1)}, ${Math.round(y1)}) to (${Math.round(x2)}, ${Math.round(y2)})
                            </div>
                        </div>
                    `;
                });

                detectionList.innerHTML = html;
            },

            hideVideo() {
                document.getElementById('videoFeed').style.display = 'none';
                document.getElementById('noVideo').style.display = 'flex';
                document.getElementById('noVideo').innerHTML = `
                    <div>
                        <div>üì∑ Vision system disconnected</div>
                        <div style="font-size: 14px; margin-top: 10px;">Attempting to reconnect...</div>
                    </div>
                `;
            }
        };

        // ========== Performance Monitor ==========
        const PerformanceMonitor = {
            // Record frame timestamp and calculate metrics
            recordFrameTimestamp(timestamp) {
                const timestamps = DashboardState.performanceMonitor.frameTimestamps;
                timestamps.push(timestamp);

                // Keep circular buffer of last N frames
                if (timestamps.length > DashboardState.performanceMonitor.maxFrameHistory) {
                    timestamps.shift();
                }

                // Calculate and update performance metrics
                this.updatePerformanceMetrics();
            },

            updatePerformanceMetrics() {
                const timestamps = DashboardState.performanceMonitor.frameTimestamps;

                if (timestamps.length < 2) return;

                // Calculate actual FPS
                const timeDiff = timestamps[timestamps.length - 1] - timestamps[0];
                const actualFPS = ((timestamps.length - 1) / timeDiff) * 1000;

                // Calculate frame timing variance
                const frameIntervals = [];
                for (let i = 1; i < timestamps.length; i++) {
                    frameIntervals.push(timestamps[i] - timestamps[i - 1]);
                }

                const avgInterval = frameIntervals.reduce((a, b) => a + b, 0) / frameIntervals.length;
                const variance = frameIntervals.reduce((sum, interval) => {
                    return sum + Math.pow(interval - avgInterval, 2);
                }, 0) / frameIntervals.length;

                const stdDev = Math.sqrt(variance);
                const variancePercent = (stdDev / avgInterval) * 100;

                // Update UI
                this.updateActualFPS(actualFPS);
                this.updateFrameVariance(variancePercent);
                this.updateWSLatency(DashboardState.performanceMonitor.wsLatency);

                // Adaptive frame rate adjustment based on variance
                if (DashboardState.adaptiveFrameRate.enabled) {
                    this.adjustFrameRate(variancePercent);
                }

                // Update WebSocket health based on performance
                this.updateWSHealthStatus(variancePercent);
            },

            adjustFrameRate(variancePercent) {
                const adaptive = DashboardState.adaptiveFrameRate;
                const threshold = adaptive.performanceThreshold * 100; // Convert to percentage

                if (variancePercent > threshold) {
                    // High variance - reduce FPS
                    const newFPS = Math.max(
                        adaptive.minFPS,
                        adaptive.currentFPS * (1 - adaptive.adjustmentFactor)
                    );
                    adaptive.currentFPS = newFPS;
                    console.log(`Reducing FPS to ${newFPS.toFixed(1)} due to high variance (${variancePercent.toFixed(1)}%)`);
                } else if (variancePercent < threshold / 2 && adaptive.currentFPS < adaptive.maxFPS) {
                    // Low variance - can increase FPS
                    const newFPS = Math.min(
                        adaptive.maxFPS,
                        adaptive.currentFPS * (1 + adaptive.adjustmentFactor)
                    );
                    adaptive.currentFPS = newFPS;
                    console.log(`Increasing FPS to ${newFPS.toFixed(1)} due to good performance (${variancePercent.toFixed(1)}%)`);
                }

                // Update target FPS display
                document.getElementById('targetFps').textContent = adaptive.currentFPS.toFixed(1);
            },

            updateActualFPS(fps) {
                const element = document.getElementById('actualFps');
                const metric = document.getElementById('actualFpsMetric');
                element.textContent = fps.toFixed(1);

                // Color code based on target
                const target = DashboardState.adaptiveFrameRate.currentFPS;
                if (fps >= target * 0.9) {
                    metric.className = 'performance-metric good';
                } else if (fps >= target * 0.7) {
                    metric.className = 'performance-metric warning';
                } else {
                    metric.className = 'performance-metric bad';
                }
            },

            updateFrameVariance(variance) {
                const element = document.getElementById('frameVariance');
                const metric = document.getElementById('frameVarianceMetric');
                element.textContent = variance.toFixed(1) + '%';

                // Color code based on thresholds
                if (variance < 10) {
                    metric.className = 'performance-metric good';
                } else if (variance < 15) {
                    metric.className = 'performance-metric warning';
                } else {
                    metric.className = 'performance-metric bad';
                }
            },

            updateWSLatency(latency) {
                const element = document.getElementById('wsLatency');
                const metric = document.getElementById('wsLatencyMetric');
                element.textContent = latency.toFixed(0) + ' ms';

                // Color code based on latency
                if (latency < 50) {
                    metric.className = 'performance-metric good';
                } else if (latency < 100) {
                    metric.className = 'performance-metric warning';
                } else {
                    metric.className = 'performance-metric bad';
                }
            },

            updateQueueDepth(depth) {
                const element = document.getElementById('msgQueue');
                const metric = document.getElementById('msgQueueMetric');
                element.textContent = depth;

                // Color code based on queue depth
                if (depth < 3) {
                    metric.className = 'performance-metric good';
                } else if (depth < 7) {
                    metric.className = 'performance-metric warning';
                } else {
                    metric.className = 'performance-metric bad';
                }
            },

            updateDroppedFrames(count) {
                const element = document.getElementById('droppedFrames');
                const metric = document.getElementById('droppedFramesMetric');
                element.textContent = count;

                // Color code based on dropped frame count
                if (count < 10) {
                    metric.className = 'performance-metric good';
                } else if (count < 50) {
                    metric.className = 'performance-metric warning';
                } else {
                    metric.className = 'performance-metric bad';
                }
            },

            updateWSHealth(status) {
                const indicator = document.getElementById('wsHealthIndicator');

                switch(status) {
                    case 'healthy':
                        indicator.className = 'ws-health-indicator healthy';
                        break;
                    case 'degraded':
                        indicator.className = 'ws-health-indicator degraded';
                        break;
                    case 'disconnected':
                    case 'error':
                        indicator.className = 'ws-health-indicator';
                        break;
                }
            },

            updateWSHealthStatus(variancePercent) {
                const queue = DashboardState.performanceMonitor.messageQueue.length;
                const latency = DashboardState.performanceMonitor.wsLatency;

                // Determine overall health
                if (variancePercent > 20 || queue > 7 || latency > 150) {
                    this.updateWSHealth('degraded');
                } else if (DashboardState.visionSystemActive) {
                    this.updateWSHealth('healthy');
                }
            },

            // Reset performance metrics
            reset() {
                DashboardState.performanceMonitor.frameTimestamps = [];
                DashboardState.performanceMonitor.droppedFrames = 0;
                DashboardState.performanceMonitor.messageQueue = [];
                DashboardState.performanceMonitor.wsLatency = 0;
            }
        };

        // ========== Character Management ==========
        const CharacterManager = {
            emotionIcons: {
                'excited': 'üéâ', 'happy': 'üòä', 'curious': 'ü§î', 'concerned': 'üòü',
                'protective': 'üõ°Ô∏è', 'loyal': 'üíô', 'sad': 'üò¢', 'angry': 'üò†',
                'frustrated': 'üò§', 'playful': 'üòÑ', 'affectionate': 'üíï',
                'respectful': 'üôè', 'alert': '‚ö†Ô∏è', 'determined': 'üí™'
            },

            updateCharacterDisplay(data) {
                if (data.character_detections && data.character_detections.length > 0) {
                    this.displayCharacters(data.character_detections, data.stats);
                    this.updateCharacterHistory(data.character_detections);
                } else {
                    this.clearCharacterDisplay();
                }
            },

            displayCharacters(characters, stats) {
                const characterList = document.getElementById('characterList');
                let html = '';
                let totalConfidence = 0;

                characters.forEach((character) => {
                    totalConfidence += character.confidence;
                    const emotionIcon = this.emotionIcons[character.r2d2_reaction.primary_emotion] || 'ü§ñ';

                    html += `
                        <div class="character-detection-item" style="border-left: 4px solid #10b981; margin: 5px 0; padding: 8px; background: #1e293b; border-radius: 4px;">
                            <div class="character-header" style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>${emotionIcon} ${character.name}</span>
                                <span style="color: #10b981;">${(character.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                                Costume: ${character.costume_match} | R2D2: ${character.r2d2_reaction.primary_emotion}
                            </div>
                        </div>
                    `;
                });

                if (characterList) characterList.innerHTML = html;

                // Update stats
                document.getElementById('recognizedCharacters').textContent = characters.length;
                document.getElementById('confidenceLevel').textContent =
                    (totalConfidence / characters.length * 100).toFixed(0) + '%';
                document.getElementById('recognitionTime').textContent =
                    (stats.character_time * 1000 || 0).toFixed(1);
            },

            updateCharacterHistory(characters) {
                const characterHistory = document.getElementById('characterHistory');
                if (!characterHistory) return;

                const timestamp = new Date().toLocaleTimeString();
                const historyItem = `
                    <div style="padding: 4px; font-size: 12px; color: #94a3b8;">
                        ${timestamp}: ${characters.map(c => c.name).join(', ')}
                    </div>
                `;

                characterHistory.insertAdjacentHTML('afterbegin', historyItem);

                // Keep only last 10 history items
                while (characterHistory.children.length > 10) {
                    characterHistory.removeChild(characterHistory.lastChild);
                }
            },

            clearCharacterDisplay() {
                const characterList = document.getElementById('characterList');
                if (characterList) {
                    characterList.innerHTML = '<div style="text-align: center; color: #64748b;">No characters detected</div>';
                }
                document.getElementById('recognizedCharacters').textContent = '0';
                document.getElementById('confidenceLevel').textContent = '0%';
            }
        };

        // ========== UI Manager ==========
        const UIManager = {
            updateConnectionStatus(message, connected) {
                const status = document.getElementById('connectionStatus');
                status.textContent = message;
                status.className = connected ? 'connected' : '';
            },

            updateVisionConnectionStatus(message, connected) {
                const status = document.getElementById('visionConnectionStatus');
                status.textContent = message;
                status.className = connected ? 'connected' : '';
            },

            updateSystemStats(stats) {
                if (stats.cpu !== undefined) document.getElementById('cpuUsage').textContent = stats.cpu + '%';
                if (stats.memory !== undefined) document.getElementById('memoryUsage').textContent = stats.memory + '%';
                if (stats.temperature !== undefined) document.getElementById('temperature').textContent = stats.temperature + '¬∞C';
                if (stats.gpu !== undefined) document.getElementById('gpuUsage').textContent = stats.gpu + '%';
            },

            updateR2D2Status(status) {
                if (status.servos !== undefined) document.getElementById('activeServos').textContent = status.servos;
                if (status.audio !== undefined) document.getElementById('audioStatus').textContent = status.audio;
                if (status.vision !== undefined) document.getElementById('visionStatus').textContent = status.vision;
                if (status.health !== undefined) document.getElementById('systemHealth').textContent = status.health + '%';
                if (status.servoTiming !== undefined) document.getElementById('servoTiming').textContent = status.servoTiming + ' ms';
                if (status.audioLatency !== undefined) document.getElementById('audioLatency').textContent = status.audioLatency + ' ms';
            },

            showAlert(message, level = 'info') {
                const alerts = document.getElementById('alerts');
                const alert = document.createElement('div');
                alert.className = level === 'error' ? 'alert' : level === 'success' ? 'success' : 'info';
                alert.textContent = message;
                alerts.insertBefore(alert, alerts.firstChild);

                setTimeout(() => {
                    if (alert.parentNode) alert.parentNode.removeChild(alert);
                }, 5000);
            },

            updateUptime() {
                const startTime = new Date();
                setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now - startTime) / 1000);
                    const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
                    const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                    const seconds = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('uptime').textContent = `${hours}:${minutes}:${seconds}`;
                }, 1000);
            }
        };

        // ========== Control Functions (Global for onclick) ==========
        // Main control functions
        function testServos() {
            WebSocketManager.sendCommand('test_servos');
            UIManager.showAlert('Testing servos...', 'info');
        }

        function testAudio() {
            WebSocketManager.sendCommand('test_audio');
            UIManager.showAlert('Testing audio system...', 'info');
        }

        function testVision() {
            WebSocketManager.sendCommand('test_vision');
            UIManager.showAlert('Testing vision system...', 'info');
        }

        function runFullDemo() {
            WebSocketManager.sendCommand('full_demo');
            UIManager.showAlert('Running full R2D2 demonstration...', 'info');
        }

        function emergencyStop() {
            WebSocketManager.sendCommand('emergency_stop');
            UIManager.showAlert('Emergency stop activated!', 'error');
        }

        // Vision control functions
        function toggleVisionSystem() {
            if (DashboardState.visionSystemActive) {
                UIManager.showAlert('Vision system stop not implemented via WebSocket', 'info');
            } else {
                WebSocketManager.connectToVision();
            }
        }

        function captureFrame() {
            if (DashboardState.visionSystemActive) {
                UIManager.showAlert('Frame capture functionality would be implemented here', 'info');
            } else {
                UIManager.showAlert('Vision system not connected', 'error');
            }
        }

        function toggleDetectionDisplay() {
            DashboardState.showDetections = !DashboardState.showDetections;
            const detectionList = document.getElementById('detectionList');

            if (!DashboardState.showDetections) {
                detectionList.innerHTML = '<div style="text-align: center; color: #64748b;">Detection display disabled</div>';
                UIManager.showAlert('Detection display disabled', 'info');
            } else {
                UIManager.showAlert('Detection display enabled', 'info');
            }
        }

        // Servo control functions
        function updateServo(channel, value) {
            WebSocketManager.sendCommand('update_servo', {channel, value});
            const servoChannel = document.querySelector(`[data-channel="${channel}"] .servo-value`);
            if (servoChannel) servoChannel.textContent = value + '¬∞';
        }

        function homeAllServos() {
            WebSocketManager.sendCommand('home_all_servos');
            UIManager.showAlert('Homing all servos...', 'info');
        }

        function enableAllServos() {
            WebSocketManager.sendCommand('enable_all_servos');
            UIManager.showAlert('Enabling all servos...', 'info');
        }

        function disableAllServos() {
            WebSocketManager.sendCommand('disable_all_servos');
            UIManager.showAlert('Disabling all servos...', 'info');
        }

        function saveServoPreset() {
            WebSocketManager.sendCommand('save_servo_preset');
            UIManager.showAlert('Saving servo preset...', 'info');
        }

        function loadServoPreset() {
            WebSocketManager.sendCommand('load_servo_preset');
            UIManager.showAlert('Loading servo preset...', 'info');
        }

        // Audio control functions
        function playSound(soundType) {
            WebSocketManager.sendCommand('play_sound', {soundType});
            UIManager.showAlert(`Playing ${soundType} sound...`, 'info');
        }

        function updateVolume(value) {
            WebSocketManager.sendCommand('update_volume', {volume: value});
            document.getElementById('volumeValue').textContent = value;
        }

        function stopAllAudio() {
            WebSocketManager.sendCommand('stop_all_audio');
            UIManager.showAlert('Stopping all audio...', 'info');
        }

        function muteAudio() {
            WebSocketManager.sendCommand('mute_audio');
            UIManager.showAlert('Muting audio...', 'info');
        }

        // Character recognition functions
        function enableCharacterRecognition() {
            WebSocketManager.sendCommand('enable_character_recognition');
            UIManager.showAlert('Enabling character recognition...', 'info');
        }

        function disableCharacterRecognition() {
            WebSocketManager.sendCommand('disable_character_recognition');
            UIManager.showAlert('Disabling character recognition...', 'info');
        }

        function clearCharacterHistory() {
            const characterHistory = document.getElementById('characterHistory');
            if (characterHistory) characterHistory.innerHTML = '<div style="text-align: center; color: #64748b;">No history available</div>';
            UIManager.showAlert('Character history cleared', 'info');
        }

        function exportCharacterData() {
            UIManager.showAlert('Character data export not yet implemented', 'info');
        }

        // Behavior sequence functions
        function playSequence(sequenceName) {
            WebSocketManager.sendCommand('play_sequence', {sequence: sequenceName});
            UIManager.showAlert(`Playing ${sequenceName} sequence...`, 'info');
        }

        function stopCurrentSequence() {
            WebSocketManager.sendCommand('stop_sequence');
            UIManager.showAlert('Stopping current sequence...', 'info');
        }

        function pauseCurrentSequence() {
            WebSocketManager.sendCommand('pause_sequence');
            UIManager.showAlert('Pausing sequence...', 'info');
        }

        function resumeCurrentSequence() {
            WebSocketManager.sendCommand('resume_sequence');
            UIManager.showAlert('Resuming sequence...', 'info');
        }

        function updateSequenceSpeed(speed) {
            WebSocketManager.sendCommand('update_sequence_speed', {speed: parseFloat(speed)});
            UIManager.showAlert(`Sequence speed set to ${speed}x`, 'info');
        }

        function createCustomSequence() {
            UIManager.showAlert('Custom sequence creation not yet implemented', 'info');
        }

        // Safety functions
        function emergencyStopAll() {
            WebSocketManager.sendCommand('emergency_stop_all');
            UIManager.showAlert('üö® EMERGENCY STOP ALL SYSTEMS!', 'error');
        }

        function emergencyStopServos() {
            WebSocketManager.sendCommand('emergency_stop_servos');
            UIManager.showAlert('Emergency stopping servos...', 'error');
        }

        function emergencyStopAudio() {
            WebSocketManager.sendCommand('emergency_stop_audio');
            UIManager.showAlert('Emergency stopping audio...', 'error');
        }

        function softShutdown() {
            WebSocketManager.sendCommand('soft_shutdown');
            UIManager.showAlert('Initiating soft shutdown...', 'info');
        }

        function runDiagnostic(type) {
            WebSocketManager.sendCommand('run_diagnostic', {type});
            UIManager.showAlert(`Running ${type} diagnostic...`, 'info');
        }

        // ========== Event Listeners ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Confidence slider
            document.getElementById('confidenceSlider').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value);
                document.getElementById('confidenceValue').textContent = value.toFixed(2);

                if (DashboardState.visionWs && DashboardState.visionWs.readyState === WebSocket.OPEN) {
                    DashboardState.visionWs.send(JSON.stringify({
                        type: 'update_confidence',
                        threshold: value
                    }));
                }
            });
        });

        // ========== Initialization ==========
        window.addEventListener('load', () => {
            UIManager.updateUptime();
            WebSocketManager.connectToDashboard();

            setTimeout(() => {
                WebSocketManager.connectToVision();
            }, 2000);

            setInterval(() => WebSocketManager.requestSystemData(), 5000);
            UIManager.showAlert('R2D2 Dashboard with Vision System loaded', 'success');
        });
    </script>
</body>
</html>