<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2D2 Multi-Agent Dashboard with Real-time Vision</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: #0f172a;
            color: #f8fafc;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .vision-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
        }
        .system-section {
            display: grid;
            grid-template-rows: auto auto auto;
            gap: 20px;
        }
        .status-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .value {
            font-weight: bold;
            color: #10b981;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }
        .alert {
            background: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #16a34a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background: #0ea5e9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        #connectionStatus {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 5px;
            background: #dc2626;
            z-index: 1000;
        }
        #connectionStatus.connected {
            background: #16a34a;
        }

        /* Vision-specific styles */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-feed {
            width: 100%;
            height: auto;
            display: block;
        }
        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        .detection-info {
            margin-top: 15px;
        }
        .detection-list {
            max-height: 300px;
            overflow-y: auto;
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .detection-item {
            padding: 8px;
            margin: 5px 0;
            background: #1e293b;
            border-radius: 4px;
            border-left: 4px solid #10b981;
        }
        .detection-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .detection-confidence {
            color: #10b981;
        }
        .detection-coords {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .vision-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .vision-stat {
            background: #0f172a;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #10b981;
        }
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
        }
        .confidence-control {
            margin-top: 15px;
        }
        .confidence-slider {
            width: 100%;
            margin: 10px 0;
        }
        .no-video {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background: #000;
            color: #64748b;
            border-radius: 8px;
            font-size: 18px;
        }
        #visionConnectionStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            background: #dc2626;
            color: white;
            font-size: 12px;
        }
        #visionConnectionStatus.connected {
            background: #16a34a;
        }
    </style>
</head>
<body>
    <div id="connectionStatus">Dashboard Disconnected</div>

    <div class="header">
        <h1>üéØ R2D2 Multi-Agent Dashboard with Real-time Vision</h1>
        <p>Real-time monitoring, control system, and live object detection</p>
    </div>

    <div class="main-container">
        <!-- Vision Section -->
        <div class="vision-section">
            <h3>üëÅÔ∏è Real-time Vision System</h3>
            <div id="visionConnectionStatus">Vision Disconnected</div>

            <div class="video-container">
                <img id="videoFeed" class="video-feed" style="display: none;" alt="Live video feed">
                <div id="noVideo" class="no-video">
                    <div>
                        <div>üì∑ Connecting to camera...</div>
                        <div style="font-size: 14px; margin-top: 10px;">Waiting for vision system</div>
                    </div>
                </div>
            </div>

            <div class="vision-stats">
                <div class="vision-stat">
                    <div class="stat-value" id="visionFPS">--</div>
                    <div class="stat-label">FPS</div>
                </div>
                <div class="vision-stat">
                    <div class="stat-value" id="detectionCount">--</div>
                    <div class="stat-label">Detections</div>
                </div>
                <div class="vision-stat">
                    <div class="stat-value" id="detectionTime">--</div>
                    <div class="stat-label">Detection Time (ms)</div>
                </div>
                <div class="vision-stat">
                    <div class="stat-value" id="totalDetections">--</div>
                    <div class="stat-label">Total Detected</div>
                </div>
            </div>

            <div class="confidence-control">
                <label for="confidenceSlider">Confidence Threshold: <span id="confidenceValue">0.5</span></label>
                <input type="range" id="confidenceSlider" class="confidence-slider"
                       min="0.1" max="1.0" step="0.05" value="0.5">
            </div>

            <div class="controls">
                <button onclick="toggleVisionSystem()">Start Vision</button>
                <button onclick="captureFrame()">Capture Frame</button>
                <button onclick="toggleDetectionDisplay()">Toggle Detections</button>
            </div>

            <div class="detection-info">
                <h4>Live Detections</h4>
                <div id="detectionList" class="detection-list">
                    <div style="text-align: center; color: #64748b;">No detections yet...</div>
                </div>
            </div>
        </div>

        <!-- System Status Section -->
        <div class="system-section">
            <div class="status-card">
                <h3>üñ•Ô∏è System Performance</h3>
                <div class="metric">
                    <span>CPU Usage:</span>
                    <span class="value" id="cpuUsage">--%</span>
                </div>
                <div class="metric">
                    <span>Memory Usage:</span>
                    <span class="value" id="memoryUsage">--%</span>
                </div>
                <div class="metric">
                    <span>Temperature:</span>
                    <span class="value" id="temperature">--¬∞C</span>
                </div>
                <div class="metric">
                    <span>GPU Usage:</span>
                    <span class="value" id="gpuUsage">--%</span>
                </div>
            </div>

            <div class="status-card">
                <h3>üé≠ R2D2 Status</h3>
                <div class="metric">
                    <span>Active Servos:</span>
                    <span class="value" id="activeServos">--</span>
                </div>
                <div class="metric">
                    <span>Audio System:</span>
                    <span class="value" id="audioStatus">--</span>
                </div>
                <div class="metric">
                    <span>Vision System:</span>
                    <span class="value" id="visionStatus">--</span>
                </div>
                <div class="metric">
                    <span>System Health:</span>
                    <span class="value" id="systemHealth">--%</span>
                </div>
            </div>

            <div class="status-card">
                <h3>üé™ Performance Metrics</h3>
                <div class="metric">
                    <span>Servo Timing:</span>
                    <span class="value" id="servoTiming">-- ms</span>
                </div>
                <div class="metric">
                    <span>Audio Latency:</span>
                    <span class="value" id="audioLatency">-- ms</span>
                </div>
                <div class="metric">
                    <span>Vision Inference:</span>
                    <span class="value" id="visionInference">-- ms</span>
                </div>
                <div class="metric">
                    <span>Uptime:</span>
                    <span class="value" id="uptime">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Control Sections -->
    <div class="control-sections">
        <!-- Servo Control Matrix -->
        <div class="status-card servo-control-section">
            <h3>‚öôÔ∏è Servo Control Matrix - Pololu Maestro Mini 12</h3>
            <div class="servo-grid">
                <div class="servo-channel" data-channel="0">
                    <label>Dome Rotation</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(0, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="1">
                    <label>Head Tilt</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(1, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="2">
                    <label>Periscope</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(2, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="3">
                    <label>Radar Eye</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(3, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="4">
                    <label>Panel 1</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(4, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="5">
                    <label>Panel 2</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(5, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="6">
                    <label>Panel 3</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(6, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="7">
                    <label>Panel 4</label>
                    <input type="range" min="0" max="120" value="0" class="servo-slider"
                           onchange="updateServo(7, this.value)">
                    <span class="servo-value">0¬∞</span>
                </div>
                <div class="servo-channel" data-channel="8">
                    <label>Utility Arm 1</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(8, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="9">
                    <label>Utility Arm 2</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(9, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="10">
                    <label>Interface Arm</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(10, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
                <div class="servo-channel" data-channel="11">
                    <label>Gripper</label>
                    <input type="range" min="0" max="180" value="90" class="servo-slider"
                           onchange="updateServo(11, this.value)">
                    <span class="servo-value">90¬∞</span>
                </div>
            </div>
            <div class="servo-controls">
                <button onclick="homeAllServos()">Home All</button>
                <button onclick="enableAllServos()">Enable All</button>
                <button onclick="disableAllServos()">Disable All</button>
                <button onclick="saveServoPreset()">Save Preset</button>
                <button onclick="loadServoPreset()">Load Preset</button>
            </div>
        </div>

        <!-- Audio Control Panel -->
        <div class="status-card audio-control-section">
            <h3>üîä Audio Control Panel - R2D2 Sound Effects</h3>
            <div class="audio-grid">
                <div class="audio-category">
                    <h4>Emotional Responses</h4>
                    <div class="audio-buttons">
                        <button onclick="playSound('happy')">Happy/Excited</button>
                        <button onclick="playSound('sad')">Sad/Worried</button>
                        <button onclick="playSound('curious')">Curious</button>
                        <button onclick="playSound('frustrated')">Frustrated</button>
                        <button onclick="playSound('surprised')">Surprised</button>
                        <button onclick="playSound('playful')">Playful</button>
                    </div>
                </div>
                <div class="audio-category">
                    <h4>Character Interactions</h4>
                    <div class="audio-buttons">
                        <button onclick="playSound('greeting')">Greeting</button>
                        <button onclick="playSound('chatting')">Chatting</button>
                        <button onclick="playSound('sarcastic')">Sarcastic</button>
                        <button onclick="playSound('affection')">Affectionate</button>
                        <button onclick="playSound('stubborn')">Stubborn</button>
                        <button onclick="playSound('alert')">Alert/Warning</button>
                    </div>
                </div>
                <div class="audio-category">
                    <h4>Star Wars Specific</h4>
                    <div class="audio-buttons">
                        <button onclick="playSound('jedi_recognition')">Jedi Recognition</button>
                        <button onclick="playSound('princess_leia')">Princess Leia Message</button>
                        <button onclick="playSound('astromech_duties')">Astromech Duties</button>
                        <button onclick="playSound('power_up')">Power Up</button>
                        <button onclick="playSound('memory_wipe')">Memory Wipe</button>
                        <button onclick="playSound('musical')">Musical Entertainment</button>
                    </div>
                </div>
            </div>
            <div class="audio-controls">
                <label for="volumeSlider">Volume: <span id="volumeValue">75</span>%</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="75"
                       onchange="updateVolume(this.value)">
                <button onclick="stopAllAudio()">Stop All</button>
                <button onclick="muteAudio()">Mute</button>
            </div>
            <div class="audio-queue">
                <h4>Audio Queue</h4>
                <div id="audioQueue" class="queue-list">
                    <div style="text-align: center; color: #64748b;">No sounds queued</div>
                </div>
            </div>
        </div>

        <!-- Character Recognition Panel -->
        <div class="status-card character-recognition-section">
            <h3>üé≠ Character Recognition Display</h3>
            <div class="character-grid">
                <div class="character-stats">
                    <div class="character-stat">
                        <div class="stat-value" id="recognizedCharacters">--</div>
                        <div class="stat-label">Recognized Characters</div>
                    </div>
                    <div class="character-stat">
                        <div class="stat-value" id="confidenceLevel">--%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="character-stat">
                        <div class="stat-value" id="recognitionTime">--</div>
                        <div class="stat-label">Recognition Time (ms)</div>
                    </div>
                </div>
                <div class="character-list">
                    <h4>Current Characters</h4>
                    <div id="characterList" class="character-detections">
                        <div style="text-align: center; color: #64748b;">No characters detected</div>
                    </div>
                </div>
                <div class="character-history">
                    <h4>Recent History</h4>
                    <div id="characterHistory" class="character-history-list">
                        <div style="text-align: center; color: #64748b;">No history available</div>
                    </div>
                </div>
            </div>
            <div class="character-controls">
                <button onclick="enableCharacterRecognition()">Enable Recognition</button>
                <button onclick="disableCharacterRecognition()">Disable Recognition</button>
                <button onclick="clearCharacterHistory()">Clear History</button>
                <button onclick="exportCharacterData()">Export Data</button>
            </div>
        </div>

        <!-- Behavior Sequences Library -->
        <div class="status-card behavior-sequences-section">
            <h3>üé™ Behavior Sequences Library</h3>
            <div class="sequence-grid">
                <div class="sequence-category">
                    <h4>Emotional Sequences</h4>
                    <div class="sequence-buttons">
                        <button onclick="playSequence('excited')" class="sequence-btn">
                            <span class="sequence-name">Excited</span>
                            <span class="sequence-duration">4s</span>
                        </button>
                        <button onclick="playSequence('curious')" class="sequence-btn">
                            <span class="sequence-name">Curious</span>
                            <span class="sequence-duration">3s</span>
                        </button>
                        <button onclick="playSequence('frustrated')" class="sequence-btn">
                            <span class="sequence-name">Frustrated</span>
                            <span class="sequence-duration">5s</span>
                        </button>
                        <button onclick="playSequence('happy')" class="sequence-btn">
                            <span class="sequence-name">Happy</span>
                            <span class="sequence-duration">3s</span>
                        </button>
                    </div>
                </div>
                <div class="sequence-category">
                    <h4>Functional Sequences</h4>
                    <div class="sequence-buttons">
                        <button onclick="playSequence('scanning')" class="sequence-btn">
                            <span class="sequence-name">Scanning</span>
                            <span class="sequence-duration">6s loop</span>
                        </button>
                        <button onclick="playSequence('maintenance')" class="sequence-btn">
                            <span class="sequence-name">Maintenance</span>
                            <span class="sequence-duration">8s</span>
                        </button>
                        <button onclick="playSequence('greeting')" class="sequence-btn">
                            <span class="sequence-name">Greeting</span>
                            <span class="sequence-duration">4s</span>
                        </button>
                        <button onclick="playSequence('demonstration')" class="sequence-btn">
                            <span class="sequence-name">Demonstration</span>
                            <span class="sequence-duration">12s</span>
                        </button>
                    </div>
                </div>
                <div class="sequence-category">
                    <h4>Custom Sequences</h4>
                    <div class="sequence-buttons">
                        <button onclick="playSequence('user_defined_1')" class="sequence-btn">
                            <span class="sequence-name">Custom 1</span>
                            <span class="sequence-duration">--</span>
                        </button>
                        <button onclick="playSequence('user_defined_2')" class="sequence-btn">
                            <span class="sequence-name">Custom 2</span>
                            <span class="sequence-duration">--</span>
                        </button>
                        <button onclick="createCustomSequence()" class="sequence-btn create-btn">
                            <span class="sequence-name">Create New</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="sequence-controls">
                <button onclick="stopCurrentSequence()">Stop Current</button>
                <button onclick="pauseCurrentSequence()">Pause</button>
                <button onclick="resumeCurrentSequence()">Resume</button>
                <select id="sequenceSpeed" onchange="updateSequenceSpeed(this.value)">
                    <option value="0.5">0.5x Speed</option>
                    <option value="1.0" selected>Normal Speed</option>
                    <option value="1.5">1.5x Speed</option>
                    <option value="2.0">2x Speed</option>
                </select>
            </div>
            <div class="sequence-status">
                <div class="current-sequence">
                    <span>Current: </span><span id="currentSequence">None</span>
                </div>
                <div class="sequence-progress">
                    <span>Progress: </span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="sequenceProgress"></div>
                    </div>
                    <span id="sequenceTime">0:00 / 0:00</span>
                </div>
            </div>
        </div>

        <!-- Safety Dashboard -->
        <div class="status-card safety-dashboard-section">
            <h3>üõ°Ô∏è Safety Dashboard</h3>
            <div class="safety-grid">
                <div class="safety-status">
                    <h4>System Status</h4>
                    <div class="safety-indicators">
                        <div class="safety-indicator" id="servoSafety">
                            <span class="indicator-light"></span>
                            <span>Servo Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                        <div class="safety-indicator" id="audioSafety">
                            <span class="indicator-light"></span>
                            <span>Audio Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                        <div class="safety-indicator" id="visionSafety">
                            <span class="indicator-light"></span>
                            <span>Vision Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                        <div class="safety-indicator" id="powerSafety">
                            <span class="indicator-light"></span>
                            <span>Power Systems</span>
                            <span class="status-text">Normal</span>
                        </div>
                    </div>
                </div>
                <div class="safety-controls">
                    <h4>Emergency Controls</h4>
                    <button onclick="emergencyStopAll()" class="emergency-btn">
                        üö® EMERGENCY STOP ALL
                    </button>
                    <button onclick="emergencyStopServos()" class="emergency-btn-small">
                        Stop Servos
                    </button>
                    <button onclick="emergencyStopAudio()" class="emergency-btn-small">
                        Stop Audio
                    </button>
                    <button onclick="softShutdown()" class="emergency-btn-small">
                        Soft Shutdown
                    </button>
                </div>
                <div class="safety-diagnostics">
                    <h4>Diagnostics</h4>
                    <div class="diagnostic-tests">
                        <button onclick="runDiagnostic('servo')">Test Servos</button>
                        <button onclick="runDiagnostic('audio')">Test Audio</button>
                        <button onclick="runDiagnostic('vision')">Test Vision</button>
                        <button onclick="runDiagnostic('communication')">Test Comms</button>
                        <button onclick="runDiagnostic('full')">Full System Test</button>
                    </div>
                    <div class="diagnostic-results">
                        <h5>Last Test Results</h5>
                        <div id="diagnosticResults">
                            <div style="text-align: center; color: #64748b;">No tests run</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-card">
        <h3>üéÆ Control Panel</h3>
        <div class="controls">
            <button onclick="testServos()">Test Servos</button>
            <button onclick="testAudio()">Test Audio</button>
            <button onclick="testVision()">Test Vision</button>
            <button onclick="runFullDemo()">Full Demo</button>
            <button onclick="emergencyStop()">Emergency Stop</button>
        </div>
    </div>

    <div id="alerts"></div>

    <script>
        // Dashboard WebSocket connection
        let dashboardWs = null;
        let dashboardReconnectInterval = null;

        // Vision WebSocket connection
        let visionWs = null;
        let visionReconnectInterval = null;
        let visionSystemActive = false;
        let showDetections = true;

        // Performance tracking
        let detectionStats = {
            totalFrames: 0,
            totalDetections: 0,
            avgFPS: 0
        };

        function connectToDashboard() {
            try {
                dashboardWs = new WebSocket('ws://localhost:8766');

                dashboardWs.onopen = function() {
                    document.getElementById('connectionStatus').textContent = 'Dashboard Connected';
                    document.getElementById('connectionStatus').className = 'connected';
                    clearInterval(dashboardReconnectInterval);
                    requestSystemData();
                };

                dashboardWs.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleDashboardMessage(data);
                };

                dashboardWs.onclose = function() {
                    document.getElementById('connectionStatus').textContent = 'Dashboard Disconnected';
                    document.getElementById('connectionStatus').className = '';
                    attemptDashboardReconnect();
                };

                dashboardWs.onerror = function(error) {
                    console.error('Dashboard WebSocket error:', error);
                };
            } catch (error) {
                console.error('Dashboard connection failed:', error);
                attemptDashboardReconnect();
            }
        }

        function connectToVision() {
            try {
                visionWs = new WebSocket('ws://localhost:8767');

                visionWs.onopen = function() {
                    document.getElementById('visionConnectionStatus').textContent = 'Vision Connected';
                    document.getElementById('visionConnectionStatus').className = 'connected';
                    clearInterval(visionReconnectInterval);
                    visionSystemActive = true;
                    showAlert('Vision system connected', 'success');
                };

                visionWs.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleVisionMessage(data);
                };

                visionWs.onclose = function() {
                    document.getElementById('visionConnectionStatus').textContent = 'Vision Disconnected';
                    document.getElementById('visionConnectionStatus').className = '';
                    visionSystemActive = false;
                    hideVideo();
                    attemptVisionReconnect();
                };

                visionWs.onerror = function(error) {
                    console.error('Vision WebSocket error:', error);
                };
            } catch (error) {
                console.error('Vision connection failed:', error);
                attemptVisionReconnect();
            }
        }

        function attemptDashboardReconnect() {
            if (!dashboardReconnectInterval) {
                dashboardReconnectInterval = setInterval(() => {
                    console.log('Attempting to reconnect to dashboard...');
                    connectToDashboard();
                }, 5000);
            }
        }

        function attemptVisionReconnect() {
            if (!visionReconnectInterval) {
                visionReconnectInterval = setInterval(() => {
                    console.log('Attempting to reconnect to vision system...');
                    connectToVision();
                }, 5000);
            }
        }

        function handleDashboardMessage(data) {
            switch(data.type) {
                case 'system_stats':
                    updateSystemStats(data.stats);
                    break;
                case 'r2d2_status':
                    updateR2D2Status(data.status);
                    break;
                case 'alert':
                    showAlert(data.message, data.level);
                    break;
            }
        }

        function handleVisionMessage(data) {
            switch(data.type) {
                case 'connection_status':
                    showAlert(data.message, 'info');
                    break;
                case 'vision_data':
                    updateVisionDisplay(data);
                    break;
                case 'heartbeat':
                    // Keep connection alive
                    break;
            }
        }

        function updateVisionDisplay(data) {
            // Update video feed
            const videoFeed = document.getElementById('videoFeed');
            const noVideo = document.getElementById('noVideo');

            if (data.frame) {
                videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
                videoFeed.style.display = 'block';
                noVideo.style.display = 'none';
            }

            // Update stats
            if (data.stats) {
                document.getElementById('visionFPS').textContent = data.stats.fps.toFixed(1);
                document.getElementById('detectionTime').textContent = (data.stats.detection_time * 1000).toFixed(1);
                document.getElementById('totalDetections').textContent = data.stats.total_detections;

                // Update inference time in R2D2 status
                document.getElementById('visionInference').textContent = (data.stats.detection_time * 1000).toFixed(1) + ' ms';
            }

            // Update detections display
            if (data.detections && showDetections) {
                updateDetectionsList(data.detections);
                document.getElementById('detectionCount').textContent = data.detections.length;
            }

            // Update detection stats
            detectionStats.totalFrames++;
            detectionStats.totalDetections += data.detections ? data.detections.length : 0;
        }

        function updateDetectionsList(detections) {
            const detectionList = document.getElementById('detectionList');

            if (detections.length === 0) {
                detectionList.innerHTML = '<div style="text-align: center; color: #64748b;">No detections in current frame</div>';
                return;
            }

            let html = '';
            detections.forEach((detection, index) => {
                const [x1, y1, x2, y2] = detection.bbox;
                html += `
                    <div class="detection-item">
                        <div class="detection-header">
                            <span>${detection.class}</span>
                            <span class="detection-confidence">${(detection.confidence * 100).toFixed(1)}%</span>
                        </div>
                        <div class="detection-coords">
                            Box: (${Math.round(x1)}, ${Math.round(y1)}) to (${Math.round(x2)}, ${Math.round(y2)})
                        </div>
                    </div>
                `;
            });

            detectionList.innerHTML = html;
        }

        function hideVideo() {
            document.getElementById('videoFeed').style.display = 'none';
            document.getElementById('noVideo').style.display = 'flex';
            document.getElementById('noVideo').innerHTML = `
                <div>
                    <div>üì∑ Vision system disconnected</div>
                    <div style="font-size: 14px; margin-top: 10px;">Attempting to reconnect...</div>
                </div>
            `;
        }

        function updateSystemStats(stats) {
            if (stats.cpu !== undefined) document.getElementById('cpuUsage').textContent = stats.cpu + '%';
            if (stats.memory !== undefined) document.getElementById('memoryUsage').textContent = stats.memory + '%';
            if (stats.temperature !== undefined) document.getElementById('temperature').textContent = stats.temperature + '¬∞C';
            if (stats.gpu !== undefined) document.getElementById('gpuUsage').textContent = stats.gpu + '%';
        }

        function updateR2D2Status(status) {
            if (status.servos !== undefined) document.getElementById('activeServos').textContent = status.servos;
            if (status.audio !== undefined) document.getElementById('audioStatus').textContent = status.audio;
            if (status.vision !== undefined) document.getElementById('visionStatus').textContent = status.vision;
            if (status.health !== undefined) document.getElementById('systemHealth').textContent = status.health + '%';
            if (status.servoTiming !== undefined) document.getElementById('servoTiming').textContent = status.servoTiming + ' ms';
            if (status.audioLatency !== undefined) document.getElementById('audioLatency').textContent = status.audioLatency + ' ms';
        }

        function requestSystemData() {
            if (dashboardWs && dashboardWs.readyState === WebSocket.OPEN) {
                dashboardWs.send(JSON.stringify({type: 'request_data'}));
            }
        }

        function sendCommand(command, params = {}) {
            if (dashboardWs && dashboardWs.readyState === WebSocket.OPEN) {
                dashboardWs.send(JSON.stringify({type: 'command', command: command, params: params}));
            }
        }

        // Control functions
        function testServos() {
            sendCommand('test_servos');
            showAlert('Testing servos...', 'info');
        }

        function testAudio() {
            sendCommand('test_audio');
            showAlert('Testing audio system...', 'info');
        }

        function testVision() {
            sendCommand('test_vision');
            showAlert('Testing vision system...', 'info');
        }

        function runFullDemo() {
            sendCommand('full_demo');
            showAlert('Running full R2D2 demonstration...', 'info');
        }

        function emergencyStop() {
            sendCommand('emergency_stop');
            showAlert('Emergency stop activated!', 'error');
        }

        // Vision control functions
        function toggleVisionSystem() {
            if (visionSystemActive) {
                // Vision system is running, button should stop it
                showAlert('Vision system stop not implemented via WebSocket', 'info');
            } else {
                // Attempt to connect to vision system
                connectToVision();
            }
        }

        function captureFrame() {
            if (visionSystemActive) {
                showAlert('Frame capture functionality would be implemented here', 'info');
            } else {
                showAlert('Vision system not connected', 'error');
            }
        }

        function toggleDetectionDisplay() {
            showDetections = !showDetections;
            const detectionList = document.getElementById('detectionList');

            if (!showDetections) {
                detectionList.innerHTML = '<div style="text-align: center; color: #64748b;">Detection display disabled</div>';
                showAlert('Detection display disabled', 'info');
            } else {
                showAlert('Detection display enabled', 'info');
            }
        }

        // Confidence threshold control
        document.getElementById('confidenceSlider').addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            document.getElementById('confidenceValue').textContent = value.toFixed(2);

            // Send confidence update to vision system if connected
            if (visionWs && visionWs.readyState === WebSocket.OPEN) {
                visionWs.send(JSON.stringify({
                    type: 'update_confidence',
                    threshold: value
                }));
            }
        });

        function showAlert(message, level = 'info') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');

            if (level === 'error') {
                alert.className = 'alert';
            } else if (level === 'success') {
                alert.className = 'success';
            } else {
                alert.className = 'info';
            }

            alert.textContent = message;
            alerts.insertBefore(alert, alerts.firstChild);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        function updateUptime() {
            const startTime = new Date();
            setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('uptime').textContent = hours + ':' + minutes + ':' + seconds;
            }, 1000);
        }

        // Initialize connections
        function initializeConnections() {
            connectToDashboard();

            // Attempt vision connection after a short delay
            setTimeout(() => {
                connectToVision();
            }, 2000);
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            updateUptime();
            initializeConnections();
            setInterval(requestSystemData, 5000);

            showAlert('R2D2 Dashboard with Vision System loaded', 'success');
        });
    </script>
</body>
</html>